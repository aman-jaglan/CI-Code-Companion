<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository Browser - CI Code Companion</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/diff-viewer.css') }}">
    
    <!-- Scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>
    
    <style>
        :root {
            --sidebar-width: 320px;
            --header-height: 64px;
            --bottom-panel-height: 300px;
        }
        
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-layout {
            height: calc(100vh - var(--header-height));
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: 1fr;
            overflow: hidden;
        }
        
        .content-area {
            display: grid;
            grid-template-rows: 1fr auto var(--bottom-panel-height);
            min-height: 0;
            overflow: hidden;
        }
        
        .content-area.no-bottom-panel {
            grid-template-rows: 1fr auto;
        }
        
        .monaco-editor-area {
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }
        
        .monaco-container {
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        .sidebar {
            background: #1e293b;
            color: #e2e8f0;
            overflow: hidden;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .tab-content {
            display: none;
            height: 100%;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .file-tree, .commits-list, .pr-list {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .file-tree-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .file-tree-item:hover {
            background-color: #334155;
        }
        
        .file-tree-item.selected {
            background-color: #3b82f6;
        }
        
        .file-tree-item .icon {
            width: 20px;
            margin-right: 8px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .commit-item {
            padding: 12px;
            border-bottom: 1px solid #334155;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .commit-item:hover {
            background-color: #334155;
        }
        
        .bottom-panel {
            background: #1e293b;
            color: #e2e8f0;
            border-top: 1px solid #334155;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .bottom-panel-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .ai-analysis-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            margin: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .severity-critical { border-left: 4px solid #ef4444; }
        .severity-high { border-left: 4px solid #f97316; }
        .severity-medium { border-left: 4px solid #eab308; }
        .severity-low { border-left: 4px solid #22c55e; }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: #334155;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .breadcrumb a {
            color: #60a5fa;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .search-box {
            background: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .action-button {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            outline: none;
            text-decoration: none;
            white-space: nowrap;
        }
        
        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        .btn-ai-review { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-ai-review:hover:not(:disabled) {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-ai-review:disabled {
            opacity: 0.8;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-test-gen { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            min-width: 160px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-test-gen:hover:not(:disabled) {
            background: linear-gradient(135deg, #0e8074 0%, #2dd968 100%);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
        }
        
        .btn-test-gen:disabled {
            opacity: 0.8;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-commit { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .btn-commit:hover {
            background: linear-gradient(135deg, #ff5252 0%, #d44638 100%);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }
        
        .resize-handle {
            background: #334155;
            cursor: row-resize;
            height: 4px;
            position: relative;
            flex-shrink: 0;
        }
        
        .resize-handle:hover {
            background: #3b82f6;
        }
        
        .sidebar-tabs {
            flex-shrink: 0;
        }
        
        .search-section {
            flex-shrink: 0;
        }
        
        .tab-header {
            flex-shrink: 0;
        }
        
        /* Ensure Monaco editor doesn't overflow */
        #monaco-editor-container {
            width: 100%;
            height: 100%;
        }
        
        /* Prevent text overflow in sidebar */
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Ensure proper scrolling in panels */
        .overflow-y-auto {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Header height constraint */
        header {
            height: var(--header-height);
            flex-shrink: 0;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100" x-data="repositoryBrowser()">
    <!-- Header -->
    <header class="bg-gray-800 shadow-lg h-16 flex items-center px-6 border-b border-gray-700">
        <div class="flex items-center flex-1">
            <!-- Logo and Project Name -->
            <div class="flex items-center">
                <a href="/" class="flex items-center text-xl font-bold mr-6 text-white hover:text-blue-400 transition-colors">
                    <i class="fas fa-code-branch text-green-500 mr-2"></i>
                    CI Code Companion
                </a>
                <div class="flex items-center space-x-4 text-gray-300">
                    <i class="fab fa-gitlab text-orange-500"></i>
                    <span x-text="projectName" class="font-medium">Loading...</span>
                    <span class="text-gray-500">/</span>
                    <div class="flex items-center bg-gray-700 px-3 py-1 rounded">
                        <i class="fas fa-code-branch mr-2 text-sm"></i>
                        <select x-model="currentBranch" @change="switchBranch()" class="bg-transparent text-white text-sm border-none outline-none">
                            <template x-for="branch in branches" :key="branch.name">
                                <option :value="branch.name" x-text="branch.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Header Actions -->
        <div class="flex items-center space-x-4">
            <!-- File Actions -->
            <div x-show="selectedFile" class="flex items-center space-x-3">
                <button @click="analyzeCode('review')" 
                        :disabled="loading"
                        class="action-button btn-ai-review">
                    <div class="flex items-center space-x-2">
                        <div x-show="!loading || analysisType !== 'review'" class="flex items-center space-x-2">
                            <i class="fas fa-robot text-lg"></i>
                            <span class="font-medium">AI Review</span>
                        </div>
                        <div x-show="loading && analysisType === 'review'" class="flex items-center space-x-2">
                            <div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                            <span class="font-medium">Analyzing...</span>
                        </div>
                    </div>
                </button>
                
                <button @click="analyzeCode('test')" 
                        :disabled="loading"
                        class="action-button btn-test-gen">
                    <div class="flex items-center space-x-2">
                        <div x-show="!loading || analysisType !== 'test'" class="flex items-center space-x-2">
                            <i class="fas fa-vial text-lg"></i>
                            <span class="font-medium">Generate Tests</span>
                        </div>
                        <div x-show="loading && analysisType === 'test'" class="flex items-center space-x-2">
                            <div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                            <span class="font-medium">Generating...</span>
                        </div>
                    </div>
                </button>
                
                <button x-show="hasChanges" @click="commitChanges()" class="action-button btn-commit">
                    <i class="fas fa-upload"></i>
                    Commit Changes
                </button>
            </div>
            
            <!-- Navigation -->
            <a href="/projects" class="action-button btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Projects
            </a>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Sidebar Tabs -->
            <div class="sidebar-tabs flex border-b border-gray-600">
                <button @click="activeTab = 'files'" 
                        :class="{'bg-blue-600': activeTab === 'files', 'bg-gray-700': activeTab !== 'files'}"
                        class="flex-1 px-4 py-3 text-sm font-medium">
                    <i class="fas fa-folder-tree mr-2"></i>
                    Files
                </button>
                <button @click="activeTab = 'commits'" 
                        :class="{'bg-blue-600': activeTab === 'commits', 'bg-gray-700': activeTab !== 'commits'}"
                        class="flex-1 px-4 py-3 text-sm font-medium">
                    <i class="fas fa-history mr-2"></i>
                    Commits
                </button>
                <button @click="activeTab = 'pullrequests'" 
                        :class="{'bg-blue-600': activeTab === 'pullrequests', 'bg-gray-700': activeTab !== 'pullrequests'}"
                        class="flex-1 px-4 py-3 text-sm font-medium">
                    <i class="fas fa-code-pull-request mr-2"></i>
                    PRs
                </button>
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Files Tab -->
                <div x-show="activeTab === 'files'" class="tab-content active">
                    <!-- Search -->
                    <div class="search-section p-4 border-b border-gray-600">
                        <input type="text" x-model="fileSearch" @input="filterFiles()" 
                               placeholder="Search files..." class="search-box">
                    </div>
                    
                    <!-- Breadcrumb -->
                    <div class="breadcrumb" x-show="currentPath">
                        <template x-for="(part, index) in pathParts" :key="index">
                            <span>
                                <a href="#" @click="navigateToPath(getPathUpTo(index))" x-text="part"></a>
                                <span x-show="index < pathParts.length - 1" class="mx-2 text-gray-500">/</span>
                            </span>
                        </template>
                    </div>
                    
                    <!-- File Tree -->
                    <div class="file-tree">
                        <template x-for="item in filteredFiles" :key="item.path">
                            <div @click="selectFile(item)" 
                                 :class="{'selected': selectedFile?.path === item.path}"
                                 class="file-tree-item">
                                <i :class="getFileIcon(item)" class="icon"></i>
                                <span x-text="item.name" class="flex-1 truncate"></span>
                                <span x-show="item.type === 'tree'" class="text-xs text-gray-400">
                                    <i class="fas fa-chevron-right"></i>
                                </span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Commits Tab -->
                <div x-show="activeTab === 'commits'" class="tab-content">
                    <div class="tab-header p-4 border-b border-gray-600">
                        <h3 class="font-medium mb-2">Recent Commits</h3>
                        <div class="flex items-center space-x-2 text-sm text-gray-400">
                            <span x-text="commits.length">0</span>
                            <span>commits on</span>
                            <span x-text="currentBranch">main</span>
                        </div>
                    </div>
                    
                    <div class="commits-list">
                        <template x-for="commit in commits" :key="commit.id">
                            <div class="commit-item" @click="viewCommit(commit)">
                                <div class="flex items-start space-x-3">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mt-2 flex-shrink-0"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-sm truncate" x-text="commit.title"></div>
                                        <div class="text-xs text-gray-400 mt-1">
                                            <span x-text="commit.author_name"></span>
                                            <span class="mx-1">•</span>
                                            <span x-text="formatDate(commit.authored_date)"></span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1 font-mono" x-text="commit.short_id"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Pull Requests Tab -->
                <div x-show="activeTab === 'pullrequests'" class="tab-content">
                    <div class="tab-header p-4 border-b border-gray-600">
                        <h3 class="font-medium mb-2">Pull Requests</h3>
                        <div class="flex space-x-2 text-sm">
                            <button @click="prFilter = 'open'" 
                                    :class="{'text-blue-400': prFilter === 'open', 'text-gray-400': prFilter !== 'open'}"
                                    class="hover:text-blue-300">
                                Open (<span x-text="pullRequests.filter(pr => pr.state === 'opened').length">0</span>)
                            </button>
                            <button @click="prFilter = 'merged'" 
                                    :class="{'text-blue-400': prFilter === 'merged', 'text-gray-400': prFilter !== 'merged'}"
                                    class="hover:text-blue-300">
                                Merged (<span x-text="pullRequests.filter(pr => pr.state === 'merged').length">0</span>)
                            </button>
                        </div>
                    </div>
                    
                    <div class="pr-list">
                        <template x-for="pr in filteredPullRequests" :key="pr.id">
                            <div class="commit-item" @click="viewPullRequest(pr)">
                                <div class="flex items-start space-x-3">
                                    <div :class="getPRIcon(pr.state)" class="mt-1 flex-shrink-0"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-sm truncate" x-text="pr.title"></div>
                                        <div class="text-xs text-gray-400 mt-1">
                                            <span x-text="pr.author.name"></span>
                                            <span class="mx-1">•</span>
                                            <span x-text="formatDate(pr.created_at)"></span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <span x-text="pr.source_branch"></span>
                                            <i class="fas fa-arrow-right mx-1"></i>
                                            <span x-text="pr.target_branch"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area" :class="{'no-bottom-panel': !showBottomPanel}">
            <!-- Monaco Editor Area -->
            <div class="monaco-editor-area relative bg-gray-800">
                <!-- File Header -->
                <div x-show="selectedFile" class="bg-gray-700 px-6 py-3 border-b border-gray-600 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center space-x-3">
                        <i :class="getFileIcon(selectedFile)" class="text-lg"></i>
                        <span class="font-medium" x-text="selectedFile?.name">Select a file</span>
                        <span x-show="selectedFile" class="text-sm text-gray-400 truncate" x-text="selectedFile?.path"></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span x-show="fileSize" class="text-xs text-gray-400" x-text="fileSize"></span>
                        <span x-show="selectedFile" class="text-xs text-gray-400" x-text="getFileLanguage(selectedFile)"></span>
                    </div>
                </div>

                <!-- Monaco Editor Container -->
                <div id="monaco-editor-container" class="monaco-container"></div>
                
                <!-- Empty State -->
                <div x-show="!selectedFile" class="absolute inset-0 flex items-center justify-center text-gray-500">
                    <div class="text-center">
                        <i class="fas fa-file-code text-6xl mb-4 text-gray-600"></i>
                        <h3 class="text-xl font-medium mb-2">Select a file to view</h3>
                        <p class="text-gray-400">Choose a file from the repository tree to start editing</p>
                    </div>
                </div>

                <!-- Loading Overlay -->
                <div x-show="loading" class="loading-overlay">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                        <p class="text-white" x-text="loadingMessage">Loading...</p>
                    </div>
                </div>
                
                <!-- AI Analysis Thinking Overlay -->
                <div x-show="loading && analysisType" class="absolute inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
                    <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 border border-gray-600 shadow-2xl">
                        <div class="text-center">
                            <!-- Thinking Animation -->
                            <div class="mb-6">
                                <div class="relative">
                                    <div class="w-16 h-16 mx-auto bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mb-4">
                                        <i class="fas fa-robot text-white text-2xl"></i>
                                    </div>
                                    <div class="absolute inset-0 w-16 h-16 mx-auto border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                </div>
                            </div>
                            
                            <!-- Analysis Status -->
                            <h3 class="text-xl font-semibold text-white mb-2">AI Analysis in Progress</h3>
                            <p class="text-gray-300 mb-4" x-text="getAnalysisMessage()"></p>
                            
                            <!-- File Info -->
                            <div class="bg-gray-700 rounded-lg p-3 mb-4">
                                <div class="flex items-center justify-center space-x-2 text-sm text-gray-300">
                                    <i :class="getFileIcon(selectedFile)" class="text-blue-400"></i>
                                    <span x-text="selectedFile?.name"></span>
                                    <span class="text-gray-500">•</span>
                                    <span x-text="getFileLanguage(selectedFile)"></span>
                                </div>
                            </div>
                            
                            <!-- Thinking Steps -->
                            <div class="text-left space-y-2">
                                <div class="flex items-center space-x-3 text-sm">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-gray-300">Reading file content...</span>
                                </div>
                                <div class="flex items-center space-x-3 text-sm" x-show="analysisStep >= 2">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-gray-300">Analyzing code structure...</span>
                                </div>
                                <div class="flex items-center space-x-3 text-sm" x-show="analysisStep >= 3">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-gray-300" x-text="getAnalysisStepMessage()"></span>
                                </div>
                                <div class="flex items-center space-x-3 text-sm" x-show="analysisStep >= 4">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-gray-300">Finalizing results...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resize Handle -->
            <div x-show="showBottomPanel" class="resize-handle" @mousedown="startResize($event)"></div>

            <!-- Bottom Panel - AI Analysis -->
            <div x-show="showBottomPanel" class="bottom-panel">
                <!-- Bottom Panel Tabs -->
                <div class="flex border-b border-gray-600 bg-gray-800 flex-shrink-0">
                    <button @click="bottomTab = 'analysis'" 
                            :class="{'bg-blue-600': bottomTab === 'analysis', 'bg-gray-700': bottomTab !== 'analysis'}"
                            class="px-4 py-3 text-sm font-medium">
                        <i class="fas fa-robot mr-2"></i>
                        AI Analysis
                        <span x-show="analysisResults.length" class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full" x-text="analysisResults.length"></span>
                    </button>
                    <button @click="bottomTab = 'suggestions'" 
                            :class="{'bg-blue-600': bottomTab === 'suggestions', 'bg-gray-700': bottomTab !== 'suggestions'}"
                            class="px-4 py-3 text-sm font-medium">
                        <i class="fas fa-lightbulb mr-2"></i>
                        Suggestions
                        <span x-show="suggestions.length" class="ml-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded-full" x-text="suggestions.length"></span>
                    </button>
                    <button @click="bottomTab = 'tests'" 
                            :class="{'bg-blue-600': bottomTab === 'tests', 'bg-gray-700': bottomTab !== 'tests'}"
                            class="px-4 py-3 text-sm font-medium">
                        <i class="fas fa-vial mr-2"></i>
                        Generated Tests
                        <span x-show="generatedTests && generatedTests.test_code" class="ml-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">1</span>
                    </button>
                    
                    <!-- Close Button -->
                    <div class="ml-auto flex items-center">
                        <button @click="showBottomPanel = false" class="p-3 hover:bg-gray-600 text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Bottom Panel Content -->
                <div class="bottom-panel-content">
                    <!-- Analysis Results -->
                    <div x-show="bottomTab === 'analysis'" class="p-4">
                        <template x-for="result in analysisResults" :key="result.id">
                            <div :class="'ai-analysis-card severity-' + result.severity">
                                <div class="p-4">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex items-center space-x-2">
                                            <i :class="getSeverityIcon(result.severity)" class="text-lg"></i>
                                            <h4 class="font-medium" x-text="result.title"></h4>
                                            <span :class="getSeverityBadge(result.severity)" 
                                                  class="px-2 py-1 text-xs rounded-full" 
                                                  x-text="result.severity.toUpperCase()"></span>
                                        </div>
                                        <button @click="applyFix(result)" 
                                                x-show="result.suggestedFix"
                                                class="action-button btn-primary text-xs">
                                            <i class="fas fa-magic"></i>
                                            Apply Fix
                                        </button>
                                    </div>
                                    <p class="text-gray-300 mb-3" x-text="result.description"></p>
                                    <div x-show="result.codeSnippet" class="bg-gray-900 p-3 rounded text-sm font-mono mb-3">
                                        <pre x-text="result.codeSnippet"></pre>
                                    </div>
                                    <div x-show="result.recommendation" class="text-sm text-blue-300">
                                        <i class="fas fa-lightbulb mr-1"></i>
                                        <span x-text="result.recommendation"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="analysisResults.length === 0" class="text-center py-8 text-gray-500">
                            <i class="fas fa-robot text-4xl mb-3"></i>
                            <p>No analysis results yet. Run AI analysis on a file to see results here.</p>
                        </div>
                    </div>

                    <!-- Suggestions -->
                    <div x-show="bottomTab === 'suggestions'" class="p-4">
                        <!-- Suggestions content will go here -->
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-lightbulb text-4xl mb-3"></i>
                            <p>AI suggestions will appear here when available.</p>
                        </div>
                    </div>

                    <!-- Generated Tests -->
                    <div x-show="bottomTab === 'tests'" class="p-4">
                        <div x-show="generatedTests && generatedTests.test_code" class="space-y-4">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-medium text-green-400">
                                        <i class="fas fa-vial mr-2"></i>
                                        Generated Test Code
                                    </h4>
                                    <button @click="copyTestCode()" class="action-button btn-primary text-xs">
                                        <i class="fas fa-copy"></i>
                                        Copy Code
                                    </button>
                                </div>
                                <pre class="bg-gray-900 p-3 rounded text-sm font-mono overflow-x-auto text-green-300" x-text="generatedTests.test_code"></pre>
                            </div>
                            
                            <div x-show="generatedTests.explanation" class="bg-gray-800 rounded-lg p-4">
                                <h4 class="font-medium text-blue-400 mb-2">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Test Explanation
                                </h4>
                                <p class="text-gray-300 text-sm" x-text="generatedTests.explanation"></p>
                            </div>
                            
                            <div x-show="generatedTests.coverage_areas && generatedTests.coverage_areas.length" class="bg-gray-800 rounded-lg p-4">
                                <h4 class="font-medium text-purple-400 mb-2">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    Coverage Areas
                                </h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <template x-for="area in generatedTests.coverage_areas" :key="area">
                                        <li x-text="area"></li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Empty state -->
                        <div x-show="!generatedTests || !generatedTests.test_code" class="text-center py-8 text-gray-500">
                            <i class="fas fa-vial text-4xl mb-3"></i>
                            <p>No tests generated yet. Click "Generate Tests" to create test cases for your code.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alpine.js Data and Monaco Editor Script -->
    <script>
        function repositoryBrowser() {
            return {
                // Data
                projectId: null,
                projectName: 'Loading...',
                currentBranch: 'main',
                branches: [],
                currentPath: '',
                fileTree: [],
                filteredFiles: [],
                fileSearch: '',
                selectedFile: null,
                fileSize: '',
                commits: [],
                pullRequests: [],
                loading: false,
                loadingMessage: 'Loading...',
                hasChanges: false,
                
                // UI State
                activeTab: 'files',
                bottomTab: 'analysis',
                showBottomPanel: false,
                prFilter: 'open',
                analysisType: null,
                analysisStep: 1,
                
                // AI Analysis
                analysisResults: [],
                suggestions: [],
                generatedTests: null,
                
                // Monaco Editor
                monacoEditor: null,
                
                init() {
                    console.log('=== Repository Browser Initializing ===');
                    try {
                        this.initFromURL();
                        this.loadProject();
                        console.log('Repository Browser initialized successfully');
                    } catch (error) {
                        console.error('Error initializing Repository Browser:', error);
                    }
                },
                
                initFromURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.projectId = urlParams.get('project_id');
                    this.projectName = urlParams.get('name') || 'Unknown Project';
                    
                    if (!this.projectId) {
                        alert('No project selected');
                        window.location.href = '/projects';
                        return;
                    }
                },
                
                async loadProject() {
                    try {
                        this.loading = true;
                        this.loadingMessage = 'Loading project...';
                        
                        await Promise.all([
                            this.loadBranches(),
                            this.loadFileTree(),
                            this.loadCommits(),
                            this.loadPullRequests()
                        ]);
                        
                        this.loading = false;
                    } catch (error) {
                        console.error('Error loading project:', error);
                        alert('Error loading project: ' + error.message);
                        this.loading = false;
                    }
                },
                
                async loadBranches() {
                    try {
                        const response = await fetch(`/gitlab/repository/${this.projectId}/branches`);
                        const data = await response.json();
                        this.branches = data.branches;
                        this.currentBranch = data.default_branch || 'main';
                    } catch (error) {
                        console.error('Error loading branches:', error);
                    }
                },
                
                async loadFileTree(path = '') {
                    try {
                        const response = await fetch(`/gitlab/repository/${this.projectId}/tree?branch=${this.currentBranch}&path=${path}`);
                        const data = await response.json();
                        this.fileTree = data.items.sort((a, b) => {
                            if (a.type !== b.type) return a.type === 'tree' ? -1 : 1;
                            return a.name.localeCompare(b.name);
                        });
                        this.filteredFiles = this.fileTree;
                        this.currentPath = path;
                    } catch (error) {
                        console.error('Error loading file tree:', error);
                    }
                },
                
                async loadCommits() {
                    try {
                        const response = await fetch(`/gitlab/repository/${this.projectId}/commits?branch=${this.currentBranch}&per_page=20`);
                        const data = await response.json();
                        this.commits = data.commits;
                    } catch (error) {
                        console.error('Error loading commits:', error);
                    }
                },
                
                async loadPullRequests() {
                    try {
                        // For now, using mock data - replace with actual GitLab API
                        this.pullRequests = [
                            {
                                id: 1,
                                title: 'Feature: Add user authentication',
                                state: 'opened',
                                author: { name: 'John Doe' },
                                created_at: new Date().toISOString(),
                                source_branch: 'feature/auth',
                                target_branch: 'main'
                            },
                            {
                                id: 2,
                                title: 'Fix: Memory leak in background worker',
                                state: 'merged',
                                author: { name: 'Jane Smith' },
                                created_at: new Date(Date.now() - 86400000).toISOString(),
                                source_branch: 'fix/memory-leak',
                                target_branch: 'main'
                            }
                        ];
                    } catch (error) {
                        console.error('Error loading pull requests:', error);
                    }
                },
                
                // File operations
                filterFiles() {
                    if (!this.fileSearch) {
                        this.filteredFiles = this.fileTree;
                        return;
                    }
                    
                    this.filteredFiles = this.fileTree.filter(item =>
                        item.name.toLowerCase().includes(this.fileSearch.toLowerCase())
                    );
                },
                
                async selectFile(item) {
                    if (item.type === 'tree') {
                        await this.loadFileTree(item.path);
                        return;
                    }
                    
                    try {
                        this.loading = true;
                        this.loadingMessage = 'Loading file...';
                        
                        const response = await fetch(`/gitlab/repository/${this.projectId}/file?path=${encodeURIComponent(item.path)}&branch=${this.currentBranch}`);
                        const fileData = await response.json();
                        
                        this.selectedFile = {
                            ...item,
                            content: fileData.content,
                            size: fileData.size
                        };
                        
                        this.fileSize = this.formatFileSize(fileData.size);
                        this.initMonacoEditor(fileData.content, item.name);
                        
                        this.loading = false;
                    } catch (error) {
                        console.error('Error loading file:', error);
                        alert('Error loading file: ' + error.message);
                        this.loading = false;
                    }
                },
                
                initMonacoEditor(content, filename) {
                    const container = document.getElementById('monaco-editor-container');
                    
                    // Dispose existing editor
                    if (this.monacoEditor) {
                        this.monacoEditor.dispose();
                    }
                    
                    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
                    
                    require(['vs/editor/editor.main'], () => {
                        this.monacoEditor = monaco.editor.create(container, {
                            value: content,
                            language: this.getMonacoLanguage(filename),
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: true },
                            renderLineHighlight: 'all',
                            lineNumbers: 'on',
                            scrollBeyondLastLine: false,
                            wordWrap: 'on'
                        });
                        
                        // Track changes
                        this.monacoEditor.onDidChangeModelContent(() => {
                            const newContent = this.monacoEditor.getValue();
                            this.hasChanges = newContent !== this.selectedFile.content;
                        });
                    });
                },
                
                // Simple test version
                testAnalyze(type) {
                    console.log('=== testAnalyze called ===');
                    console.log('Type:', type);
                    alert(`Test analyze called with type: ${type}`);
                },
                
                // AI Analysis
                async analyzeCode(type) {
                    console.log('[1] analyzeCode START');
                    
                    if (!this.selectedFile) {
                        console.error('[1.1] No selectedFile');
                        alert('Please select a file first.');
                        return;
                    }
                    if (!this.monacoEditor) {
                        console.error('[1.2] No monacoEditor instance');
                        alert('Editor not initialized. Please wait or refresh.');
                        return;
                    }
                    console.log('[2] Checks passed');

                    this.loading = true;
                    this.analysisType = type;
                    this.loadingMessage = `Running AI ${type} analysis...`;
                    console.log('[3] Loading state SET');

                    let content;
                    try {
                        console.log('[4] Trying monacoEditor.getValue()');
                        console.log('[4.1] Monaco Editor Instance (Alpine Proxy):', this.monacoEditor);
                        
                        const rawEditor = Alpine.raw(this.monacoEditor);
                        console.log('[4.2] Raw Monaco Editor Instance:', rawEditor);

                        if (rawEditor && typeof rawEditor.getValue === 'function') {
                            content = rawEditor.getValue();
                            console.log('[5] rawEditor.getValue() SUCCEEDED. Content length:', content?.length);
                        } else {
                            console.error('[5.E] rawEditor.getValue is not a function or editor not ready');
                            throw new Error('Raw editor not ready or getValue not available.');
                        }
                    } catch (e) {
                        console.error('[5.E] rawEditor.getValue() FAILED with exception:', e);
                        alert('Error getting content from editor. See console.');
                        this.loading = false;
                        this.analysisType = null;
                        return;
                    }

                    try {
                        console.log('[6] Starting API call to /api/ai-analyze');
                        
                        const languageForPayload = 'Python';  // Hardcoded for Python files
                        console.log('[6.0] Language hardcoded to:', languageForPayload);

                        const apiRequestBody = {
                            action: type,
                            file_path: this.selectedFile.path,
                            content: content,
                            project_id: this.projectId,
                            branch: this.currentBranch,
                            language: languageForPayload
                        };
                        console.log('[6.1] API Request Body OBJECT:', apiRequestBody);
                        const jsonString = JSON.stringify(apiRequestBody);
                        console.log('[6.2] Stringified request body:', jsonString);

                        const response = await fetch('/api/ai-analyze', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: jsonString
                        });

                        if (!response.ok) {
                            console.error('[7.1] API response NOT OK');
                            console.error('[7.2] Response status:', response.status);
                            console.error('[7.3] Response status text:', response.statusText);
                            let errorText = `HTTP error ${response.status}`;
                            try {
                                const errData = await response.json();
                                console.error('[7.4] Error response data:', errData);
                                errorText = errData.error || JSON.stringify(errData);
                            } catch (jsonErr) {
                                console.error('[7.5] Could not parse error response as JSON:', jsonErr);
                            }
                            throw new Error(errorText);
                        }

                        const result = await response.json();
                        console.log('[9] response.json() SUCCEEDED:', result);

                        if (type === 'review' && result.analysis) {
                            this.analysisResults = this.processReviewResults(result.analysis);
                            this.bottomTab = 'analysis';
                        } else if (type === 'test' && result.tests) {
                            this.generatedTests = result.tests;
                            this.bottomTab = 'tests';
                        } else {
                            console.warn('[9.1] Unexpected API result format');
                        }
                        this.showBottomPanel = true;
                        console.log('[10] Analysis processed SUCCESSFULLY');

                    } catch (error) {
                        console.error('[11.E] Error during API call or processing:', error);
                        alert(`Error: ${error.message}. Using fallback data.`);
                        
                        if (type === 'review') {
                            this.analysisResults = this.getMockReviewResults();
                            this.bottomTab = 'analysis';
                        } else {
                            this.generatedTests = this.getMockTestResults();
                            this.bottomTab = 'tests';
                        }
                        this.showBottomPanel = true;
                        console.log('[11.1] Fallback data applied');
                        
                    } finally {
                        console.log('[12] FINALLY block');
                        this.loading = false;
                        this.analysisType = null;
                        console.log('[13] Loading state CLEARED');
                    }
                },
                
                getMockReviewResults() {
                    const fileName = this.selectedFile.name;
                    const fileExt = fileName.split('.').pop()?.toLowerCase();
                    
                    return [
                        {
                            id: 1,
                            title: 'Code Quality Issue',
                            description: `Potential improvement found in ${fileName}`,
                            severity: fileExt === 'py' ? 'medium' : 'low',
                            category: 'maintainability',
                            codeSnippet: '// Code snippet would appear here',
                            recommendation: 'Consider refactoring for better readability',
                            suggestedFix: '// Improved code would appear here'
                        },
                        {
                            id: 2,
                            title: 'Best Practice Suggestion',
                            description: 'Code follows most best practices with minor suggestions',
                            severity: 'low',
                            category: 'style',
                            recommendation: 'Overall code quality is good'
                        }
                    ];
                },
                
                getMockTestResults() {
                    const fileName = this.selectedFile.name;
                    const fileExt = fileName.split('.').pop()?.toLowerCase();
                    
                    const testTemplate = fileExt === 'py' ? 
                        `import unittest\nfrom ${fileName.replace('.py', '')} import *\n\nclass Test${fileName.replace('.py', '').replace(/[^a-zA-Z0-9]/g, '')}(unittest.TestCase):\n    def test_basic_functionality(self):\n        # Test basic functionality\n        self.assertTrue(True)\n        \n    def test_edge_cases(self):\n        # Test edge cases\n        self.assertIsNotNone(None)\n\nif __name__ == '__main__':\n    unittest.main()` :
                        `// Test file for ${fileName}\ndescribe('${fileName}', () => {\n    test('should work correctly', () => {\n        expect(true).toBe(true);\n    });\n});`;
                    
                    return {
                        test_code: testTemplate,
                        explanation: `Generated comprehensive test cases for ${fileName}`,
                        coverage_areas: [
                            'Basic functionality testing',
                            'Edge case handling',
                            'Input validation',
                            'Error handling'
                        ]
                    };
                },
                
                getAnalysisMessage() {
                    if (this.analysisType === 'review') {
                        return 'Analyzing code quality, security, and best practices...';
                    } else if (this.analysisType === 'test') {
                        return 'Generating comprehensive test cases for your code...';
                    }
                    return 'Processing your request...';
                },
                
                getAnalysisStepMessage() {
                    if (this.analysisType === 'review') {
                        return 'Checking for issues and improvements...';
                    } else if (this.analysisType === 'test') {
                        return 'Creating test scenarios...';
                    }
                    return 'Processing analysis...';
                },
                
                processReviewResults(analysis) {
                    const results = [];
                    
                    // Process issues
                    if (analysis.issues && Array.isArray(analysis.issues)) {
                        analysis.issues.forEach((issue, index) => {
                            results.push({
                                id: index + 1,
                                title: this.extractIssueTitle(issue.description || issue),
                                description: issue.description || issue,
                                severity: issue.severity || this.determineSeverity(issue.description || issue),
                                category: issue.category || this.categorizeIssue(issue.description || issue),
                                codeSnippet: issue.context ? issue.context.code : '',
                                recommendation: this.extractRecommendation(issue.description || issue),
                                suggestedFix: null // Will be populated from suggested_changes
                            });
                        });
                    }
                    
                    // Process suggested changes and link them to issues
                    if (analysis.suggested_changes && Array.isArray(analysis.suggested_changes)) {
                        analysis.suggested_changes.forEach(change => {
                            const relatedIssueIndex = change.issue_index || 0;
                            
                            if (results[relatedIssueIndex]) {
                                results[relatedIssueIndex].suggestedFix = change.new_content;
                                results[relatedIssueIndex].oldContent = change.old_content;
                                results[relatedIssueIndex].lineNumber = change.line_number;
                            } else {
                                // Create a new result for standalone suggestions
                                results.push({
                                    id: results.length + 1,
                                    title: change.explanation || 'Code Improvement',
                                    description: change.explanation || 'Suggested improvement',
                                    severity: 'medium',
                                    category: 'improvement',
                                    codeSnippet: change.old_content || '',
                                    recommendation: change.explanation || '',
                                    suggestedFix: change.new_content,
                                    oldContent: change.old_content,
                                    lineNumber: change.line_number
                                });
                            }
                        });
                    }
                    
                    return results;
                },
                
                processTestResults(tests) {
                    // Update the tests tab with generated test code
                    this.generatedTests = tests;
                    
                    // Show a notification
                    if (tests.test_code) {
                        console.log('Generated test code:', tests.test_code);
                    }
                },
                
                processSuggestions(improvements) {
                    // Process improvements similar to review results
                    this.suggestions = this.processReviewResults(improvements);
                },
                
                extractIssueTitle(description) {
                    // Extract a short title from the issue description
                    const sentences = description.split('.')[0];
                    return sentences.length > 60 ? sentences.substring(0, 60) + '...' : sentences;
                },
                
                determineSeverity(description) {
                    const lowerDesc = description.toLowerCase();
                    if (lowerDesc.includes('critical') || lowerDesc.includes('security') || lowerDesc.includes('vulnerability')) {
                        return 'critical';
                    } else if (lowerDesc.includes('error') || lowerDesc.includes('bug') || lowerDesc.includes('problem')) {
                        return 'high';
                    } else if (lowerDesc.includes('warning') || lowerDesc.includes('improvement')) {
                        return 'medium';
                    } else {
                        return 'low';
                    }
                },
                
                categorizeIssue(description) {
                    const lowerDesc = description.toLowerCase();
                    if (lowerDesc.includes('security') || lowerDesc.includes('vulnerability')) {
                        return 'security';
                    } else if (lowerDesc.includes('performance') || lowerDesc.includes('slow') || lowerDesc.includes('memory')) {
                        return 'performance';
                    } else if (lowerDesc.includes('test') || lowerDesc.includes('coverage')) {
                        return 'testing';
                    } else if (lowerDesc.includes('style') || lowerDesc.includes('format')) {
                        return 'style';
                    } else {
                        return 'maintainability';
                    }
                },
                
                extractRecommendation(description) {
                    // Extract recommendation part from description
                    const parts = description.split(/[.!?]/);
                    return parts.length > 1 ? parts.slice(1).join('.').trim() : description;
                },
                
                copyTestCode() {
                    if (this.generatedTests && this.generatedTests.test_code) {
                        navigator.clipboard.writeText(this.generatedTests.test_code).then(() => {
                            // Show a temporary success message
                            const button = event.target.closest('button');
                            const originalText = button.innerHTML;
                            button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                            button.classList.remove('btn-primary');
                            button.classList.add('btn-success');
                            
                            setTimeout(() => {
                                button.innerHTML = originalText;
                                button.classList.remove('btn-success');
                                button.classList.add('btn-primary');
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy text: ', err);
                            alert('Failed to copy test code to clipboard');
                        });
                    }
                },
                
                applyFix(result) {
                    if (!this.monacoEditor || !result.suggestedFix) return;
                    
                    // Apply the suggested fix to the editor
                    const model = this.monacoEditor.getModel();
                    const selection = this.monacoEditor.getSelection();
                    
                    if (selection) {
                        model.pushEditOperations([], [{
                            range: selection,
                            text: result.suggestedFix
                        }], () => null);
                    }
                },
                
                async commitChanges() {
                    if (!this.selectedFile || !this.monacoEditor || !this.hasChanges) return;
                    
                    const newContent = this.monacoEditor.getValue();
                    const commitMessage = prompt('Enter commit message:', `Update ${this.selectedFile.name}`);
                    
                    if (!commitMessage) return;
                    
                    try {
                        this.loading = true;
                        this.loadingMessage = 'Committing changes...';
                        
                        const response = await fetch(`/gitlab/repository/${this.projectId}/commit`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                file_path: this.selectedFile.path,
                                branch: this.currentBranch,
                                content: newContent,
                                commit_message: commitMessage
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            this.hasChanges = false;
                            this.selectedFile.content = newContent;
                            alert('Changes committed successfully!');
                            await this.loadCommits(); // Refresh commits
                        } else {
                            alert('Error committing changes: ' + result.error);
                        }
                        
                        this.loading = false;
                        
                    } catch (error) {
                        console.error('Error committing changes:', error);
                        alert('Error committing changes: ' + error.message);
                        this.loading = false;
                    }
                },
                
                // UI Helpers
                async switchBranch() {
                    await this.loadFileTree();
                    await this.loadCommits();
                    if (this.selectedFile) {
                        await this.selectFile(this.selectedFile);
                    }
                },
                
                viewCommit(commit) {
                    window.open(commit.web_url, '_blank');
                },
                
                viewPullRequest(pr) {
                    // Open PR in new tab or show details
                    console.log('View PR:', pr);
                },
                
                navigateToPath(path) {
                    this.loadFileTree(path);
                },
                
                // Computed properties
                get pathParts() {
                    return this.currentPath ? this.currentPath.split('/') : [];
                },
                
                get filteredPullRequests() {
                    return this.pullRequests.filter(pr => 
                        this.prFilter === 'open' ? pr.state === 'opened' : pr.state === 'merged'
                    );
                },
                
                getPathUpTo(index) {
                    return this.pathParts.slice(0, index + 1).join('/');
                },
                
                getFileIcon(item) {
                    if (item.type === 'tree') return 'fas fa-folder text-blue-400';
                    
                    const ext = item.name.split('.').pop()?.toLowerCase();
                    const iconMap = {
                        'py': 'fab fa-python text-yellow-400',
                        'js': 'fab fa-js-square text-yellow-500',
                        'ts': 'fas fa-code text-blue-500',
                        'html': 'fab fa-html5 text-orange-500',
                        'css': 'fab fa-css3-alt text-blue-500',
                        'json': 'fas fa-file-code text-green-400',
                        'md': 'fab fa-markdown text-gray-400',
                        'yml': 'fas fa-file-code text-red-400',
                        'yaml': 'fas fa-file-code text-red-400'
                    };
                    return iconMap[ext] || 'fas fa-file text-gray-400';
                },
                
                getFileLanguage(file) {
                    const ext = file.name.split('.').pop()?.toLowerCase();
                    const langMap = {
                        'py': 'Python',
                        'js': 'JavaScript',
                        'ts': 'TypeScript',
                        'html': 'HTML',
                        'css': 'CSS',
                        'json': 'JSON',
                        'md': 'Markdown'
                    };
                    return langMap[ext] || 'Text';
                },
                
                getMonacoLanguage(filename) {
                    if (!filename || typeof filename !== 'string') {
                        console.warn('[getMonacoLanguage] Invalid filename provided:', filename);
                        return 'plaintext'; // Default if filename is bad
                    }
                    const parts = filename.split('.');
                    const ext = parts.length > 1 ? parts.pop().toLowerCase() : null;
                    
                    if (!ext) {
                        console.warn('[getMonacoLanguage] No extension found for:', filename);
                        return 'plaintext';
                    }

                    const langMap = {
                        'py': 'python',
                        'js': 'javascript',
                        'ts': 'typescript',
                        'html': 'html',
                        'css': 'css',
                        'json': 'json',
                        'md': 'markdown',
                        'yml': 'yaml',
                        'yaml': 'yaml'
                    };
                    return langMap[ext] || 'plaintext';
                },
                
                getPRIcon(state) {
                    return state === 'opened' ? 
                        'w-2 h-2 bg-green-500 rounded-full' : 
                        'w-2 h-2 bg-purple-500 rounded-full';
                },
                
                getSeverityIcon(severity) {
                    const icons = {
                        'critical': 'fas fa-exclamation-triangle text-red-500',
                        'high': 'fas fa-exclamation-circle text-orange-500',
                        'medium': 'fas fa-exclamation text-yellow-500',
                        'low': 'fas fa-info-circle text-green-500'
                    };
                    return icons[severity] || icons.medium;
                },
                
                getSeverityBadge(severity) {
                    const badges = {
                        'critical': 'bg-red-500 text-white',
                        'high': 'bg-orange-500 text-white',
                        'medium': 'bg-yellow-500 text-black',
                        'low': 'bg-green-500 text-white'
                    };
                    return badges[severity] || badges.medium;
                },
                
                formatFileSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diff = now - date;
                    
                    if (diff < 24 * 60 * 60 * 1000) {
                        return 'Today';
                    } else if (diff < 7 * 24 * 60 * 60 * 1000) {
                        return Math.floor(diff / (24 * 60 * 60 * 1000)) + ' days ago';
                    } else {
                        return date.toLocaleDateString();
                    }
                },
                
                // Panel resizing
                startResize(event) {
                    event.preventDefault();
                    
                    const startY = event.clientY;
                    const startHeight = parseInt(document.defaultView.getComputedStyle(document.querySelector('.bottom-panel')).height, 10);
                    
                    function doResize(e) {
                        const newHeight = startHeight - (e.clientY - startY);
                        const minHeight = 200;
                        const maxHeight = window.innerHeight - 300;
                        
                        if (newHeight >= minHeight && newHeight <= maxHeight) {
                            document.documentElement.style.setProperty('--bottom-panel-height', newHeight + 'px');
                        }
                    }
                    
                    function stopResize() {
                        document.removeEventListener('mousemove', doResize);
                        document.removeEventListener('mouseup', stopResize);
                    }
                    
                    document.addEventListener('mousemove', doResize);
                    document.addEventListener('mouseup', stopResize);
                }
            }
        }
    </script>
</body>
</html> 