<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository Browser - CI Code Companion</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/diff-viewer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/repository-browser.css') }}">
    
    <!-- Scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>
    
    <!-- Vis.js Network for dependency graphs -->
    <script src="https://cdn.jsdelivr.net/npm/vis-data@7.1.4/standalone/umd/vis-data.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/standalone/umd/vis-network.min.js"></script>
    
    <script src="{{ url_for('static', filename='js/repository-browser-core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/monaco-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/repository-browser-main.js') }}"></script>
</head>

<body class="bg-gray-900 text-gray-100" x-data="repositoryBrowser()">
    <!-- Header -->
    <header class="bg-gray-800 shadow-lg h-16 flex items-center px-6 border-b border-gray-700">
        <div class="flex items-center flex-1">
            <!-- Logo and Project Name -->
            <div class="flex items-center">
                <a href="/" class="flex items-center text-xl font-bold mr-6 text-white hover:text-blue-400 transition-colors">
                    <i class="fas fa-code-branch text-green-500 mr-2"></i>
                    CI Code Companion
                </a>
                <div class="flex items-center space-x-4 text-gray-300">
                    <i class="fab fa-gitlab text-orange-500"></i>
                    <span x-text="projectName" class="font-medium">Loading...</span>
                    <span class="text-gray-500">/</span>
                    <div class="flex items-center bg-gray-700 px-3 py-1 rounded">
                        <i class="fas fa-code-branch mr-2 text-sm"></i>
                        <select x-model="currentBranch" @change="switchBranch()" class="bg-transparent text-white text-sm border-none outline-none">
                            <template x-for="branch in branches" :key="branch.name">
                                <option :value="branch.name" x-text="branch.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Header Actions -->
        <div class="flex items-center space-x-4">
            <!-- File Actions -->
            <div x-show="selectedFile" class="flex items-center space-x-3">
                <button @click="analyzeCode('review')" 
                        :disabled="loading"
                        class="action-button btn-ai-review">
                    <div class="flex items-center space-x-2">
                        <div x-show="!loading || analysisType !== 'review'" class="flex items-center space-x-2">
                            <i class="fas fa-robot text-lg"></i>
                            <span class="font-medium">AI Review</span>
                        </div>
                        <div x-show="loading && analysisType === 'review'" class="flex items-center space-x-2">
                            <div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                            <span class="font-medium">Analyzing...</span>
                        </div>
                    </div>
                </button>
                
                <button @click="analyzeCode('test')" 
                        :disabled="loading"
                        class="action-button btn-test-gen">
                    <div class="flex items-center space-x-2">
                        <div x-show="!loading || analysisType !== 'test'" class="flex items-center space-x-2">
                            <i class="fas fa-vial text-lg"></i>
                            <span class="font-medium">Generate Tests</span>
                        </div>
                        <div x-show="loading && analysisType === 'test'" class="flex items-center space-x-2">
                            <div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                            <span class="font-medium">Generating...</span>
                        </div>
                    </div>
                </button>
                
                <button x-show="hasChanges" @click="commitChanges()" class="action-button btn-commit">
                    <i class="fas fa-upload"></i>
                    Commit Changes
                </button>
            </div>
            
            <!-- Navigation -->
            <a href="/projects" class="action-button btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Projects
            </a>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Global Search Header -->
            <div class="sidebar-header">
                <input type="text" x-model="globalSearch" @input="performGlobalSearch()" 
                       placeholder="Search files, commits, PRs..." class="global-search">
            </div>

            <!-- Collapsible Sections -->
            <div class="sidebar-sections">
                <!-- Files Explorer Section -->
                <div class="sidebar-section">
                    <div class="section-header" @click="toggleSection('files')" 
                         :class="{'collapsed': collapsedSections.files}">
                        <div class="flex items-center">
                            <i class="section-icon fas fa-folder-tree"></i>
                            <span>FILES EXPLORER</span>
                        </div>
                        <i class="expand-icon fas fa-chevron-down" 
                           :class="{'collapsed': collapsedSections.files}"></i>
                    </div>
                    
                    <div class="section-content" :class="{'collapsed': collapsedSections.files}">
                        <!-- Breadcrumb Navigation -->
                        <div x-show="currentPath" class="breadcrumb">
                            <template x-for="(part, index) in pathParts" :key="index">
                                <span>
                                    <a href="#" @click="navigateToPath(getPathUpTo(index))" x-text="part"></a>
                                    <span x-show="index < pathParts.length - 1" class="mx-2 text-gray-500">/</span>
                                </span>
                            </template>
                        </div>
                        
                        <!-- Hierarchical File Tree -->
                        <div class="file-tree">
                            <template x-for="item in filteredFiles" :key="item.path">
                                <div class="file-tree-item" 
                                     @click="handleFileItemClick(item, $event)"
                                     :class="{
                                         'selected': selectedFile?.path === item.path,
                                         'has-issues': item.hasIssues,
                                         'modified': item.isModified,
                                         'loading': loading && selectedFile?.path === item.path
                                     }"
                                     :style="'padding-left: ' + (item.depth * 20 + 16) + 'px'">
                                    
                                    <!-- Tree Toggle -->
                                    <div class="tree-indent">
                                        <button x-show="item.type === 'tree'" 
                                                class="tree-toggle">
                                            <i :class="item.expanded ? 'fas fa-chevron-down' : 'fas fa-chevron-right'"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- File Icon -->
                                    <i :class="getFileIcon(item)" class="file-icon"></i>
                                    
                                    <!-- File Name -->
                                    <span class="flex-1 truncate" x-text="item.name"></span>
                                    
                                    <!-- Status Indicators -->
                                    <div class="file-status" x-show="getFileStatus(item)">
                                        <span :class="getFileStatusClass(item)" x-text="getFileStatus(item)"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Commits & History Section -->
                <div class="sidebar-section">
                    <div class="section-header" @click="toggleSection('commits')" 
                         :class="{'collapsed': collapsedSections.commits}">
                        <div class="flex items-center">
                            <i class="section-icon fas fa-code-commit"></i>
                            <span>COMMITS & HISTORY</span>
                        </div>
                        <i class="expand-icon fas fa-chevron-down" 
                           :class="{'collapsed': collapsedSections.commits}"></i>
                    </div>
                    
                    <div class="section-content" :class="{'collapsed': collapsedSections.commits}">
                        <!-- Branch Selector -->
                        <div class="branch-selector">
                            <select x-model="currentBranch" @change="switchBranch()" class="branch-dropdown">
                                <template x-for="branch in branches" :key="branch.name">
                                    <option :value="branch.name" x-text="branch.name"></option>
                                </template>
                            </select>
                        </div>
                        
                        <!-- Git Graph -->
                        <div class="git-graph">
                            <div class="branch-line">
                                <div class="branch-dot branch-main"></div>
                                <span x-text="currentBranch">main</span>
                                <div class="branch-line-svg"></div>
                                <span class="text-xs">HEAD</span>
                            </div>
                            <template x-for="branch in otherBranches" :key="branch.name">
                                <div class="branch-line">
                                    <div class="branch-dot" :class="getBranchClass(branch.type)"></div>
                                    <span x-text="branch.name"></span>
                                    <div class="branch-line-svg"></div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Commit Timeline -->
                        <div class="commit-timeline">
                            <template x-for="commit in commits.slice(0, 10)" :key="commit.id">
                                <div class="commit-item" @click="viewCommit(commit)">
                                    <div class="commit-header">
                                        <div class="commit-avatar" :class="getCommitAuthorClass(commit.author_name)">
                                            <span x-text="getAuthorInitials(commit.author_name)"></span>
                                        </div>
                                        <div class="commit-info">
                                            <div class="commit-message" x-text="commit.title"></div>
                                            <div class="commit-meta">
                                                <span x-text="commit.author_name"></span>
                                                <span>•</span>
                                                <span x-text="formatDate(commit.authored_date)"></span>
                                                <span class="font-mono text-xs" x-text="commit.short_id"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="commit-stats">
                                        <div class="stat-item">
                                            <i class="fas fa-file-alt"></i>
                                            <span x-text="commit.files_changed || 0"></span>
                                        </div>
                                        <div class="stat-item stat-added">
                                            <span>+<span x-text="commit.lines_added || 0"></span></span>
                                        </div>
                                        <div class="stat-item stat-removed">
                                            <span>-<span x-text="commit.lines_deleted || 0"></span></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Commit Stats -->
                        <div class="stats-section">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value" x-text="commits.length"></div>
                                    <div class="stat-label">Total Commits</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" x-text="getUniqueAuthors().length"></div>
                                    <div class="stat-label">Contributors</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pull Requests Section -->
                <div class="sidebar-section">
                    <div class="section-header" @click="toggleSection('pullrequests')" 
                         :class="{'collapsed': collapsedSections.pullrequests}">
                        <div class="flex items-center">
                            <i class="section-icon fas fa-code-pull-request"></i>
                            <span>PULL REQUESTS</span>
                        </div>
                        <i class="expand-icon fas fa-chevron-down" 
                           :class="{'collapsed': collapsedSections.pullrequests}"></i>
                    </div>
                    
                    <div class="section-content" :class="{'collapsed': collapsedSections.pullrequests}">
                        <!-- PR Filter -->
                        <div class="pr-filter">
                            <div class="pr-filter-buttons">
                                <button @click="prFilter = 'all'" 
                                        :class="{'active': prFilter === 'all'}" 
                                        class="filter-btn">All</button>
                                <button @click="prFilter = 'open'" 
                                        :class="{'active': prFilter === 'open'}" 
                                        class="filter-btn">Open</button>
                                <button @click="prFilter = 'ready'" 
                                        :class="{'active': prFilter === 'ready'}" 
                                        class="filter-btn">Ready</button>
                                <button @click="prFilter = 'draft'" 
                                        :class="{'active': prFilter === 'draft'}" 
                                        class="filter-btn">Draft</button>
                            </div>
                        </div>
                        
                        <!-- PR Groups -->
                        <div class="pr-container">
                            <!-- Pinned PRs -->
                            <div x-show="getPinnedPRs().length > 0" class="pr-group">
                                <div class="pr-group-header">
                                    <i class="fas fa-thumbtack mr-2"></i>
                                    Pinned (<span x-text="getPinnedPRs().length"></span>)
                                </div>
                                <template x-for="pr in getPinnedPRs()" :key="pr.id">
                                    <div class="pr-item" :class="getPRClass(pr)" @click="viewPullRequest(pr)">
                                        <div class="pr-header">
                                            <div class="pr-status-icon" :class="getPRStatusClass(pr)">
                                                <i :class="getPRStatusIcon(pr)"></i>
                                            </div>
                                            <div class="pr-content">
                                                <div class="pr-title" x-text="pr.title"></div>
                                                <div class="pr-meta">
                                                    <span x-text="'#' + pr.id"></span>
                                                    <span>•</span>
                                                    <span x-text="pr.author?.name"></span>
                                                    <span>•</span>
                                                    <span x-text="formatDate(pr.created_at)"></span>
                                                </div>
                                                <div class="pr-status-bar">
                                                    <span x-show="pr.approvals" 
                                                          :class="getApprovalBadgeClass(pr)" 
                                                          class="status-badge">
                                                        <i class="fas fa-check mr-1"></i>
                                                        <span x-text="pr.approvals + '/2 approvals'"></span>
                                                    </span>
                                                    <span x-show="pr.ci_status" 
                                                          :class="getCIBadgeClass(pr)" 
                                                          class="status-badge">
                                                        <i :class="getCIIcon(pr)" class="mr-1"></i>
                                                        <span x-text="pr.ci_status"></span>
                                                    </span>
                                                </div>
                                                <div x-show="pr.labels && pr.labels.length" class="pr-labels">
                                                    <template x-for="label in pr.labels" :key="label">
                                                        <span :class="'label label-' + label" x-text="label"></span>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Ready to Merge -->
                            <div x-show="getReadyPRs().length > 0" class="pr-group">
                                <div class="pr-group-header">
                                    <i class="fas fa-code-merge mr-2"></i>
                                    Ready to Merge (<span x-text="getReadyPRs().length"></span>)
                                </div>
                                <template x-for="pr in getReadyPRs()" :key="pr.id">
                                    <div class="pr-item ready" @click="viewPullRequest(pr)">
                                        <div class="pr-header">
                                            <div class="pr-status-icon pr-status-ready">
                                                <i class="fas fa-check"></i>
                                            </div>
                                            <div class="pr-content">
                                                <div class="pr-title" x-text="pr.title"></div>
                                                <div class="pr-meta" x-text="'#' + pr.id + ' • ' + pr.author?.name"></div>
                                                <div class="pr-status-bar">
                                                    <span class="status-badge badge-approved">All checks passed</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Under Review -->
                            <div x-show="getReviewPRs().length > 0" class="pr-group">
                                <div class="pr-group-header">
                                    <i class="fas fa-eye mr-2"></i>
                                    Under Review (<span x-text="getReviewPRs().length"></span>)
                                </div>
                                <template x-for="pr in getReviewPRs().slice(0, 3)" :key="pr.id">
                                    <div class="pr-item" @click="viewPullRequest(pr)">
                                        <div class="pr-header">
                                            <div class="pr-status-icon pr-status-review">
                                                <i class="fas fa-eye"></i>
                                            </div>
                                            <div class="pr-content">
                                                <div class="pr-title" x-text="pr.title"></div>
                                                <div class="pr-meta" x-text="'#' + pr.id + ' • ' + pr.author?.name"></div>
                                                <div class="pr-status-bar">
                                                    <span class="status-badge badge-pending">Review pending</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- PR Stats -->
                        <div class="stats-section">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value" x-text="pullRequests.length"></div>
                                    <div class="stat-label">Total PRs</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" x-text="getReadyPRs().length"></div>
                                    <div class="stat-label">Ready</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Section -->
                <div class="sidebar-section">
                    <div class="section-header" @click="toggleSection('insights')" 
                         :class="{'collapsed': collapsedSections.insights}">
                        <div class="flex items-center">
                            <i class="section-icon fas fa-robot"></i>
                            <span>AI INSIGHTS</span>
                        </div>
                        <i class="expand-icon fas fa-chevron-down" 
                           :class="{'collapsed': collapsedSections.insights}"></i>
                    </div>
                    
                    <div class="section-content" :class="{'collapsed': collapsedSections.insights}">
                        <div class="p-4 text-center text-gray-400 text-sm">
                            <i class="fas fa-lightbulb text-2xl mb-2"></i>
                            <p>AI insights will appear here after analysis</p>
                        </div>
                    </div>
                </div>

                <!-- Dependency Graph Section -->
                <div class="sidebar-section">
                    <div class="section-header" @click="toggleSection('dependencies')" 
                         :class="{'collapsed': collapsedSections.dependencies}">
                        <div class="flex items-center">
                            <i class="section-icon fas fa-project-diagram"></i>
                            <span>DEPENDENCY GRAPH</span>
                        </div>
                        <i class="expand-icon fas fa-chevron-down" 
                           :class="{'collapsed': collapsedSections.dependencies}"></i>
                    </div>
                    
                    <div class="section-content" :class="{'collapsed': collapsedSections.dependencies}">
                        <!-- Graph Controls -->
                        <div class="p-3 border-b border-gray-600">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-medium text-gray-300">GRAPH VIEW</span>
                                <button @click="loadDependencyGraph()" 
                                        :disabled="loadingGraph"
                                        class="text-xs bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-white">
                                    <i :class="loadingGraph ? 'fas fa-spinner fa-spin' : 'fas fa-sync'"></i>
                                    <span x-text="loadingGraph ? 'Loading...' : 'Refresh'"></span>
                                </button>
                            </div>
                            
                            <!-- Graph Type Filter -->
                            <div class="flex space-x-2 text-xs">
                                <button @click="graphFilter = 'all'" 
                                        :class="{'bg-blue-600 text-white': graphFilter === 'all', 'bg-gray-600 text-gray-300': graphFilter !== 'all'}"
                                        class="px-2 py-1 rounded">All</button>
                                <button @click="graphFilter = 'imports'" 
                                        :class="{'bg-blue-600 text-white': graphFilter === 'imports', 'bg-gray-600 text-gray-300': graphFilter !== 'imports'}"
                                        class="px-2 py-1 rounded">Imports</button>
                                <button @click="graphFilter = 'functions'" 
                                        :class="{'bg-blue-600 text-white': graphFilter === 'functions', 'bg-gray-600 text-gray-300': graphFilter !== 'functions'}"
                                        class="px-2 py-1 rounded">Functions</button>
                            </div>
                        </div>
                        
                        <!-- Mini Graph Preview -->
                        <div class="graph-preview-container" style="height: 200px; position: relative;">
                            <div x-show="!dependencyGraph || dependencyGraph.nodes.length === 0" 
                                 class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs">
                                <div class="text-center">
                                    <i class="fas fa-project-diagram text-2xl mb-2"></i>
                                    <p>Click "Refresh" to generate<br>dependency graph</p>
                                </div>
                            </div>
                            
                            <div x-show="loadingGraph" 
                                 class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50">
                                <div class="text-center text-gray-300">
                                    <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                                    <p class="text-xs">Analyzing dependencies...</p>
                                </div>
                            </div>
                            
                            <!-- Graph Canvas -->
                            <canvas id="dependency-graph-mini" 
                                    x-show="dependencyGraph && dependencyGraph.nodes.length > 0"
                                    class="w-full h-full cursor-pointer"
                                    @click="openFullGraphView()"></canvas>
                        </div>
                        
                        <!-- Graph Stats -->
                        <div x-show="dependencyGraph && dependencyGraph.nodes.length > 0" 
                             class="p-3 border-t border-gray-600">
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="bg-gray-700 rounded p-2 text-center">
                                    <div class="font-bold text-blue-400" x-text="dependencyGraph.nodes.length"></div>
                                    <div class="text-gray-400">Files</div>
                                </div>
                                <div class="bg-gray-700 rounded p-2 text-center">
                                    <div class="font-bold text-green-400" x-text="dependencyGraph.edges.length"></div>
                                    <div class="text-gray-400">Connections</div>
                                </div>
                            </div>
                            
                            <!-- Most Connected Files -->
                            <div class="mt-2">
                                <div class="text-xs font-medium text-gray-300 mb-1">MOST CONNECTED</div>
                                <template x-for="file in getTopConnectedFiles()" :key="file.id">
                                    <div class="flex items-center justify-between text-xs py-1">
                                        <span class="truncate flex-1 text-gray-300" x-text="file.name"></span>
                                        <span class="text-blue-400 font-medium" x-text="file.connections"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area" :class="{'no-bottom-panel': !showBottomPanel}">
            <!-- Monaco Editor Area -->
            <div class="monaco-editor-area relative bg-gray-800">
                <!-- File Header -->
                <div x-show="selectedFile" class="bg-gray-700 px-6 py-3 border-b border-gray-600 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center space-x-3">
                        <i :class="getFileIcon(selectedFile)" class="text-lg"></i>
                        <span class="font-medium" x-text="selectedFile?.name">Select a file</span>
                        <span x-show="selectedFile" class="text-sm text-gray-400 truncate" x-text="selectedFile?.path"></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span x-show="fileSize" class="text-xs text-gray-400" x-text="fileSize"></span>
                        <span x-show="selectedFile" class="text-xs text-gray-400" x-text="getFileLanguage(selectedFile)"></span>
                    </div>
                </div>

                <!-- Monaco Editor Container -->
                <div class="monaco-editor-container-wrapper">
                    <div id="monaco-editor-container" class="monaco-container"></div>
                    
                    <!-- Progress Sidebar -->
                    <div x-show="loading && analysisType" 
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="transform translate-x-full"
                         x-transition:enter-end="transform translate-x-0"
                         x-transition:leave="transition ease-in duration-300"
                         x-transition:leave-start="transform translate-x-0"
                         x-transition:leave-end="transform translate-x-full"
                         class="progress-sidebar">
                        
                        <!-- Debug Info -->
                        <div class="hidden" x-data x-text="console.log('Progress sidebar visible:', loading, analysisType)"></div>
                        
                        <!-- Progress Header -->
                        <div class="p-4 border-b border-gray-600">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                        <i class="fas fa-robot text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-white">AI Analysis</h3>
                                        <p class="text-sm text-gray-400" x-text="getAnalysisMessage()"></p>
                                    </div>
                                </div>
                                <!-- Close Button -->
                                <button @click="loading = false; analysisType = null;" 
                                        class="text-gray-400 hover:text-white transition-colors p-1 rounded hover:bg-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-3">
                                <div class="flex justify-between text-sm text-gray-400 mb-1">
                                    <span>Progress</span>
                                    <span x-text="Math.round(analysisProgress) + '%'"></span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300" 
                                         :style="'width: ' + analysisProgress + '%'"></div>
                                </div>
                            </div>
                            
                            <!-- Current Step -->
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="flex items-center space-x-2">
                                    <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-cog fa-spin text-white text-sm"></i>
                                    </div>
                                    <div class="text-left">
                                        <div class="font-medium text-white" x-text="currentStep.title"></div>
                                        <div class="text-sm text-gray-400" x-text="currentStep.description"></div>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs text-gray-500" x-text="'Elapsed: ' + formatElapsedTime(analysisStartTime)"></div>
                            </div>
                        </div>
                        
                        <!-- Analysis Steps -->
                        <div class="p-4 space-y-3 flex-1">
                            <h4 class="font-medium text-white text-sm mb-3">Analysis Steps</h4>
                            <template x-for="(step, index) in analysisSteps" :key="index">
                                <div class="flex items-center space-x-3 text-sm p-2 rounded-lg" 
                                     :class="step.status === 'completed' ? 'bg-green-900 text-green-200' : 
                                             step.status === 'active' ? 'bg-blue-900 text-blue-200' : 'bg-gray-700 text-gray-400'">
                                    <div class="w-5 h-5 flex items-center justify-center">
                                        <i x-show="step.status === 'completed'" class="fas fa-check-circle text-green-400"></i>
                                        <i x-show="step.status === 'active'" class="fas fa-circle-notch fa-spin text-blue-400"></i>
                                        <i x-show="step.status === 'pending'" class="far fa-circle text-gray-500"></i>
                                    </div>
                                    <span class="flex-1" x-text="step.name"></span>
                                    <div x-show="step.status === 'completed' && step.result" class="text-xs bg-gray-600 px-2 py-1 rounded" x-text="step.result"></div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Real-time Issues Found -->
                        <div x-show="realTimeIssues.length > 0" class="p-4 border-t border-gray-600">
                            <h4 class="font-medium text-white text-sm mb-3 flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>
                                Issues Found (<span x-text="realTimeIssues.length"></span>)
                            </h4>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                <template x-for="issue in realTimeIssues" :key="issue.id">
                                    <div class="bg-gray-700 p-2 rounded text-xs">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <div :class="'w-2 h-2 rounded-full ' + getSeverityColor(issue.severity)"></div>
                                            <span class="font-medium text-white" x-text="issue.title"></span>
                                        </div>
                                        <div class="text-gray-400" x-text="issue.preview"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="p-4 border-t border-gray-600">
                            <div class="grid grid-cols-2 gap-3 text-center">
                                <div class="bg-gray-700 rounded-lg p-2">
                                    <div class="text-lg font-bold text-red-400" x-text="analysisStats.issuesFound"></div>
                                    <div class="text-xs text-gray-400">Issues</div>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-2">
                                    <div class="text-lg font-bold text-green-400" x-text="analysisStats.suggestions"></div>
                                    <div class="text-xs text-gray-400">Solutions</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div x-show="!selectedFile" class="absolute inset-0 flex items-center justify-center text-gray-500">
                    <div class="text-center">
                        <i class="fas fa-file-code text-6xl mb-4 text-gray-600"></i>
                        <h3 class="text-xl font-medium mb-2">Select a file to view</h3>
                        <p class="text-gray-400">Choose a file from the repository tree to start editing</p>
                    </div>
                </div>

                <!-- Loading Overlay -->
                <div x-show="loading && !analysisType" class="loading-overlay">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div class="loading-text" x-text="loadingMessage">Loading...</div>
                        <div class="loading-subtext">Please wait while we process your request</div>
                    </div>
                </div>
            </div>

            <!-- Resize Handle -->
            <div x-show="showBottomPanel" class="resize-handle" @mousedown="startResize($event)"></div>

            <!-- Bottom Panel - AI Analysis -->
            <div x-show="showBottomPanel" class="bottom-panel">
                <!-- Bottom Panel Tabs -->
                <div class="flex border-b border-gray-600 bg-gray-800 flex-shrink-0">
                    <button @click="bottomTab = 'analysis'" 
                            :class="{'bg-blue-600': bottomTab === 'analysis', 'bg-gray-700': bottomTab !== 'analysis'}"
                            class="px-4 py-3 text-sm font-medium">
                        <i class="fas fa-robot mr-2"></i>
                        AI Analysis
                        <span x-show="analysisResults.length" class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full" x-text="analysisResults.length"></span>
                    </button>
                    <button @click="bottomTab = 'suggestions'" 
                            :class="{'bg-blue-600': bottomTab === 'suggestions', 'bg-gray-700': bottomTab !== 'suggestions'}"
                            class="px-4 py-3 text-sm font-medium">
                        <i class="fas fa-lightbulb mr-2"></i>
                        Suggestions
                        <span x-show="suggestions.length" class="ml-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded-full" x-text="suggestions.length"></span>
                    </button>
                    <button @click="bottomTab = 'tests'" 
                            :class="{'bg-blue-600': bottomTab === 'tests', 'bg-gray-700': bottomTab !== 'tests'}"
                            class="px-4 py-3 text-sm font-medium">
                        <i class="fas fa-vial mr-2"></i>
                        Generated Tests
                        <span x-show="generatedTests && generatedTests.test_code" class="ml-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">1</span>
                    </button>
                    
                    <!-- Close Button -->
                    <div class="ml-auto flex items-center">
                        <button @click="showBottomPanel = false" class="p-3 hover:bg-gray-600 text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Bottom Panel Content -->
                <div class="bottom-panel-content">
                    <!-- Analysis Results -->
                    <div x-show="bottomTab === 'analysis'" class="p-4">
                        <template x-for="result in analysisResults" :key="result.id">
                            <div :class="'ai-analysis-card severity-' + result.severity">
                                <div class="p-4">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex items-center space-x-2">
                                            <i :class="getSeverityIcon(result.severity)" class="text-lg"></i>
                                            <h4 class="font-medium" x-text="result.title"></h4>
                                            <span :class="getSeverityBadge(result.severity)" 
                                                  class="px-2 py-1 text-xs rounded-full" 
                                                  x-text="result.severity.toUpperCase()"></span>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button @click="viewDiff(result)" 
                                                    x-show="result.suggestedFix && result.oldContent"
                                                    class="action-button btn-secondary text-xs">
                                                <i class="fas fa-eye"></i>
                                                View Diff
                                            </button>
                                            <button @click="applyFix(result)" 
                                                    x-show="result.suggestedFix"
                                                    class="action-button btn-primary text-xs">
                                                <i class="fas fa-magic"></i>
                                                Apply Fix
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <p class="text-gray-300 mb-3" x-text="result.description"></p>
                                    
                                    <!-- Line Number Info -->
                                    <div x-show="result.lineNumber" class="text-xs text-gray-400 mb-3 flex items-center">
                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                        <span>Line </span>
                                        <span x-text="result.lineNumber"></span>
                                        <span class="ml-2 text-gray-500">•</span>
                                        <span class="ml-2" x-text="result.category || 'Code Quality'"></span>
                                    </div>
                                    
                                    <!-- Code Diff Viewer -->
                                    <div x-show="result.showDiff" class="mb-4">
                                        <div class="bg-gray-900 rounded-lg overflow-hidden border border-gray-600">
                                            <!-- Diff Header -->
                                            <div class="bg-gray-800 px-4 py-2 border-b border-gray-600 flex items-center justify-between">
                                                <span class="text-sm font-medium text-gray-300">Code Changes</span>
                                                <button @click="result.showDiff = false" class="text-gray-400 hover:text-white">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            
                                            <!-- Before Code -->
                                            <div x-show="result.oldContent" class="border-b border-gray-600">
                                                <div class="bg-red-900 bg-opacity-20 px-4 py-2 border-b border-red-800">
                                                    <span class="text-red-400 text-sm font-medium">
                                                        <i class="fas fa-minus mr-2"></i>Before
                                                    </span>
                                                </div>
                                                <pre class="p-4 text-sm font-mono text-red-200 bg-red-900 bg-opacity-10 overflow-x-auto" x-text="result.oldContent"></pre>
                                            </div>
                                            
                                            <!-- After Code -->
                                            <div x-show="result.suggestedFix">
                                                <div class="bg-green-900 bg-opacity-20 px-4 py-2 border-b border-green-800">
                                                    <span class="text-green-400 text-sm font-medium">
                                                        <i class="fas fa-plus mr-2"></i>After (Suggested Fix)
                                                    </span>
                                                </div>
                                                <pre class="p-4 text-sm font-mono text-green-200 bg-green-900 bg-opacity-10 overflow-x-auto" x-text="result.suggestedFix"></pre>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Recommendation -->
                                    <div x-show="result.recommendation" class="bg-blue-900 bg-opacity-20 border border-blue-800 rounded p-3 text-sm">
                                        <div class="flex items-start space-x-2">
                                            <i class="fas fa-lightbulb text-blue-400 mt-0.5"></i>
                                            <div>
                                                <div class="font-medium text-blue-300 mb-1">Recommendation</div>
                                                <div class="text-blue-200" x-text="result.recommendation"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="analysisResults.length === 0" class="text-center py-8 text-gray-500">
                            <i class="fas fa-robot text-4xl mb-3"></i>
                            <p>No analysis results yet. Run AI analysis on a file to see results here.</p>
                        </div>
                    </div>

                    <!-- Suggestions -->
                    <div x-show="bottomTab === 'suggestions'" class="p-4">
                        <!-- Suggestions content will go here -->
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-lightbulb text-4xl mb-3"></i>
                            <p>AI suggestions will appear here when available.</p>
                        </div>
                    </div>

                    <!-- Generated Tests -->
                    <div x-show="bottomTab === 'tests'" class="p-4">
                        <div x-show="generatedTests && generatedTests.test_code" class="space-y-4">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-medium text-green-400">
                                        <i class="fas fa-vial mr-2"></i>
                                        Generated Test Code
                                    </h4>
                                    <button @click="copyTestCode()" class="action-button btn-primary text-xs">
                                        <i class="fas fa-copy"></i>
                                        Copy Code
                                    </button>
                                </div>
                                <pre class="bg-gray-900 p-3 rounded text-sm font-mono overflow-x-auto text-green-300" x-text="generatedTests.test_code"></pre>
                            </div>
                            
                            <div x-show="generatedTests.explanation" class="bg-gray-800 rounded-lg p-4">
                                <h4 class="font-medium text-blue-400 mb-2">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Test Explanation
                                </h4>
                                <p class="text-gray-300 text-sm" x-text="generatedTests.explanation"></p>
                            </div>
                            
                            <div x-show="generatedTests.coverage_areas && generatedTests.coverage_areas.length" class="bg-gray-800 rounded-lg p-4">
                                <h4 class="font-medium text-purple-400 mb-2">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    Coverage Areas
                                </h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <template x-for="area in generatedTests.coverage_areas" :key="area">
                                        <li x-text="area"></li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Empty state -->
                        <div x-show="!generatedTests || !generatedTests.test_code" class="text-center py-8 text-gray-500">
                            <i class="fas fa-vial text-4xl mb-3"></i>
                            <p>No tests generated yet. Click "Generate Tests" to create test cases for your code.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Dependency Graph Modal -->
    <div x-show="showGraphModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-hidden bg-black bg-opacity-75 flex items-center justify-center">
        
        <div class="bg-gray-900 w-full h-full flex flex-col">
            <!-- Graph Modal Header -->
            <div class="bg-gray-800 px-6 py-4 border-b border-gray-700 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h2 class="text-xl font-bold text-white">
                        <i class="fas fa-project-diagram mr-2 text-blue-400"></i>
                        Dependency Graph
                    </h2>
                    <div class="text-sm text-gray-400" x-text="projectName"></div>
                </div>
                
                <!-- Graph Controls -->
                <div class="flex items-center space-x-4">
                    <!-- Layout Controls -->
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-300">Layout:</label>
                        <select x-model="graphLayout" @change="updateGraphLayout()" 
                                class="bg-gray-700 text-white text-sm px-2 py-1 rounded border border-gray-600">
                            <option value="force">Force Directed</option>
                            <option value="hierarchical">Hierarchical</option>
                            <option value="circular">Circular</option>
                            <option value="grid">Grid</option>
                        </select>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-300">Show:</label>
                        <div class="flex space-x-1">
                            <button @click="toggleGraphFilter('imports')" 
                                    :class="{'bg-green-600': graphFilters.imports, 'bg-gray-600': !graphFilters.imports}"
                                    class="px-2 py-1 text-xs text-white rounded">Imports</button>
                            <button @click="toggleGraphFilter('functions')" 
                                    :class="{'bg-blue-600': graphFilters.functions, 'bg-gray-600': !graphFilters.functions}"
                                    class="px-2 py-1 text-xs text-white rounded">Functions</button>
                            <button @click="toggleGraphFilter('classes')" 
                                    :class="{'bg-purple-600': graphFilters.classes, 'bg-gray-600': !graphFilters.classes}"
                                    class="px-2 py-1 text-xs text-white rounded">Classes</button>
                        </div>
                    </div>
                    
                    <!-- Close Button -->
                    <button @click="showGraphModal = false" 
                            class="text-gray-400 hover:text-white p-2 rounded hover:bg-gray-700">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            
            <!-- Graph Content -->
            <div class="flex-1 flex">
                <!-- Main Graph Area -->
                <div class="flex-1 relative">
                    <div id="dependency-graph-full" class="w-full h-full"></div>
                    
                    <!-- Graph Loading -->
                    <div x-show="loadingFullGraph" 
                         class="absolute inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center">
                        <div class="text-center text-white">
                            <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                            <p class="text-lg">Building dependency graph...</p>
                            <p class="text-sm text-gray-400 mt-2">Analyzing file relationships</p>
                        </div>
                    </div>
                </div>
                
                <!-- Graph Information Panel -->
                <div class="w-80 bg-gray-800 border-l border-gray-700 flex flex-col">
                    <!-- Selected Node Info -->
                    <div class="p-4 border-b border-gray-700">
                        <h3 class="font-medium text-white mb-2">
                            <i class="fas fa-info-circle mr-2"></i>
                            Node Information
                        </h3>
                        
                        <div x-show="selectedNode" class="space-y-2">
                            <div class="text-sm">
                                <span class="text-gray-400">File:</span>
                                <span class="text-white font-mono text-xs" x-text="selectedNode?.name"></span>
                            </div>
                            <div class="text-sm">
                                <span class="text-gray-400">Type:</span>
                                <span class="text-blue-400" x-text="selectedNode?.type"></span>
                            </div>
                            <div class="text-sm">
                                <span class="text-gray-400">Connections:</span>
                                <span class="text-green-400" x-text="selectedNode?.connections"></span>
                            </div>
                            <div class="text-sm">
                                <span class="text-gray-400">Dependencies:</span>
                                <span class="text-yellow-400" x-text="selectedNode?.dependencies?.length || 0"></span>
                            </div>
                        </div>
                        
                        <div x-show="!selectedNode" class="text-sm text-gray-400">
                            Click on a node to see details
                        </div>
                    </div>
                    
                    <!-- Connected Files -->
                    <div class="p-4 border-b border-gray-700">
                        <h3 class="font-medium text-white mb-2">
                            <i class="fas fa-link mr-2"></i>
                            Connected Files
                        </h3>
                        
                        <div x-show="selectedNode && selectedNode.connections > 0" 
                             class="space-y-1 max-h-40 overflow-y-auto">
                            <template x-for="connection in getNodeConnections(selectedNode)" :key="connection.id">
                                <div class="flex items-center justify-between text-xs py-1 px-2 bg-gray-700 rounded">
                                    <span class="truncate flex-1 text-gray-300" x-text="connection.name"></span>
                                    <span :class="getConnectionTypeColor(connection.type)" x-text="connection.type"></span>
                                </div>
                            </template>
                        </div>
                        
                        <div x-show="!selectedNode || selectedNode.connections === 0" 
                             class="text-sm text-gray-400">
                            No connections
                        </div>
                    </div>
                    
                    <!-- Graph Statistics -->
                    <div class="p-4 flex-1">
                        <h3 class="font-medium text-white mb-2">
                            <i class="fas fa-chart-bar mr-2"></i>
                            Graph Statistics
                        </h3>
                        
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Total Files:</span>
                                <span class="text-blue-400" x-text="dependencyGraph?.nodes?.length || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Connections:</span>
                                <span class="text-green-400" x-text="dependencyGraph?.edges?.length || 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Avg. Connections:</span>
                                <span class="text-yellow-400" x-text="getAverageConnections()"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Max Connections:</span>
                                <span class="text-red-400" x-text="getMaxConnections()"></span>
                            </div>
                        </div>
                        
                        <!-- Graph Actions -->
                        <div class="mt-4 space-y-2">
                            <button @click="exportGraph()" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-download mr-2"></i>
                                Export Graph
                            </button>
                            <button @click="centerGraph()" 
                                    class="w-full bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-crosshairs mr-2"></i>
                                Center View
                            </button>
                            <button @click="refreshDependencyCache()" 
                                    class="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-refresh mr-2"></i>
                                Refresh Cache
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Library loading detection and fallback -->
    <script>
        // Global flag to track vis-network availability
        window.visNetworkLoaded = false;
        
        // Function to check if vis-network is properly loaded
        function checkVisNetwork() {
            if (typeof vis !== 'undefined' && vis.Network && vis.DataSet) {
                window.visNetworkLoaded = true;
                console.log('✅ vis-network library loaded successfully');
                console.log('Available vis objects:', Object.keys(vis));
                
                // Dispatch custom event when loaded
                window.dispatchEvent(new CustomEvent('visNetworkReady'));
                return true;
            }
            return false;
        }
        
        // Check immediately
        if (!checkVisNetwork()) {
            // Wait for scripts to load
            window.addEventListener('load', function() {
                setTimeout(() => {
                    if (!checkVisNetwork()) {
                        console.error('❌ vis-network library failed to load');
                        console.log('Will use fallback graph visualization');
                        
                        // Create a minimal vis polyfill for basic functionality
                        window.vis = {
                            DataSet: function(data) {
                                this.data = data || [];
                                this.get = () => this.data;
                                this.add = (item) => this.data.push(item);
                                this.update = (item) => console.log('DataSet update:', item);
                                this.remove = (id) => console.log('DataSet remove:', id);
                            },
                            Network: function(container, data, options) {
                                this.container = container;
                                this.data = data;
                                this.options = options;
                                
                                // Simple fallback rendering
                                this.renderFallback();
                                
                                // Mock methods
                                this.on = (event, callback) => console.log('Network event:', event);
                                this.fit = () => console.log('Network fit');
                                this.destroy = () => {
                                    if (this.container) {
                                        this.container.innerHTML = '';
                                    }
                                };
                            }
                        };
                        
                        // Add renderFallback method to Network prototype
                        window.vis.Network.prototype.renderFallback = function() {
                            if (!this.container) return;
                            
                            const nodeCount = this.data.nodes ? this.data.nodes.length || this.data.nodes.get().length : 0;
                            const edgeCount = this.data.edges ? this.data.edges.length || this.data.edges.get().length : 0;
                            
                            this.container.innerHTML = `
                                <div class="h-full flex items-center justify-center bg-gray-800 rounded-lg border border-gray-600">
                                    <div class="text-center text-gray-300 p-8">
                                        <i class="fas fa-project-diagram text-4xl mb-4 text-blue-400"></i>
                                        <h3 class="text-lg font-medium mb-2">Dependency Graph</h3>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-center space-x-6">
                                                <div class="text-center">
                                                    <div class="text-xl font-bold text-blue-400">${nodeCount}</div>
                                                    <div class="text-xs text-gray-400">Files</div>
                                                </div>
                                                <div class="text-center">
                                                    <div class="text-xl font-bold text-green-400">${edgeCount}</div>
                                                    <div class="text-xs text-gray-400">Connections</div>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-4">Interactive graph visualization unavailable</p>
                                        <p class="text-xs text-gray-500">Using fallback display</p>
                                    </div>
                                </div>
                            `;
                        };
                        
                        window.visNetworkLoaded = 'fallback';
                        window.dispatchEvent(new CustomEvent('visNetworkReady'));
                    }
                }, 1000);
            });
        }
    </script>
</body>
</html> 