<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository Browser - CI Code Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <a href="/" class="text-2xl font-bold mr-6">
                    <i class="fas fa-robot mr-2"></i>
                    CI Code Companion
                </a>
                <div class="flex items-center space-x-4">
                    <i class="fab fa-gitlab text-lg"></i>
                    <span id="project-name">Loading...</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center bg-blue-700 px-3 py-1 rounded">
                    <i class="fas fa-code-branch mr-2"></i>
                    <select id="branch-selector" class="bg-transparent border-none text-white focus:outline-none">
                        <option>Loading...</option>
                    </select>
                </div>
                <a href="/" class="hover:bg-blue-700 px-3 py-1 rounded">
                    <i class="fas fa-home mr-1"></i>
                    Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Panel: File Tree -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-folder-tree mr-2 text-blue-600"></i>
                            Repository Tree
                        </h3>
                        <div class="text-sm text-gray-600 mt-1" id="current-path">
                            /
                        </div>
                    </div>
                    <div class="p-4">
                        <div id="file-tree" class="space-y-1">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading repository...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Commits Panel -->
                <div class="bg-white rounded-lg shadow-md mt-6">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-history mr-2 text-green-600"></i>
                            Recent Commits
                        </h3>
                    </div>
                    <div class="p-4">
                        <div id="recent-commits" class="space-y-3">
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading commits...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: File Content & AI Actions -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-file-code mr-2 text-gray-600"></i>
                                <span id="current-file-name" class="font-medium">Select a file to view</span>
                            </div>
                            <div class="flex items-center space-x-2" id="file-actions" style="display: none;">
                                <button id="ai-review-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-robot mr-1"></i>
                                    AI Review
                                </button>
                                <button id="ai-test-gen-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-vial mr-1"></i>
                                    Generate Tests
                                </button>
                                <button id="ai-improve-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-magic mr-1"></i>
                                    AI Improve
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div id="file-content-area">
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-file-code text-4xl mb-4"></i>
                                <p class="text-lg">Select a file from the repository tree to view its content</p>
                                <p class="text-sm mt-2">Use AI-powered tools to review, improve, and generate tests for your code</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Results Panel -->
                <div id="ai-results-panel" class="bg-white rounded-lg shadow-md mt-6" style="display: none;">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-robot mr-2 text-purple-600"></i>
                            AI Analysis Results
                        </h3>
                    </div>
                    <div class="p-4">
                        <div id="ai-results-content">
                            <!-- AI results will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" style="display: none;">
        <div class="bg-white rounded-lg p-6">
            <div class="text-center">
                <i class="fas fa-robot fa-spin text-4xl text-blue-600 mb-4"></i>
                <p class="text-lg font-medium">AI is analyzing your code...</p>
                <p class="text-sm text-gray-600 mt-2">This may take a few moments</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentProjectId = null;
        let currentBranch = null;
        let currentPath = '';
        let currentFile = null;

        // Initialize repository browser
        async function initRepository() {
            const urlParams = new URLSearchParams(window.location.search);
            currentProjectId = urlParams.get('project_id');
            
            if (!currentProjectId) {
                alert('No project selected');
                window.location.href = '/';
                return;
            }

            try {
                // Load project info and branches
                await loadProjectInfo();
                await loadBranches();
                await loadRepositoryTree();
                await loadRecentCommits();
            } catch (error) {
                console.error('Error initializing repository:', error);
                alert('Error loading repository: ' + error.message);
            }
        }

        async function loadProjectInfo() {
            const response = await fetch('/gitlab/projects');
            const projects = await response.json();
            const project = projects.find(p => p.id == currentProjectId);
            
            if (project) {
                document.getElementById('project-name').textContent = project.name;
                currentBranch = project.default_branch;
            }
        }

        async function loadBranches() {
            const response = await fetch(`/gitlab/repository/${currentProjectId}/branches`);
            const data = await response.json();
            
            const selector = document.getElementById('branch-selector');
            selector.innerHTML = '';
            
            data.branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.name;
                option.textContent = branch.name;
                if (branch.default) {
                    option.selected = true;
                    currentBranch = branch.name;
                }
                selector.appendChild(option);
            });

            selector.addEventListener('change', async (e) => {
                currentBranch = e.target.value;
                await loadRepositoryTree();
                await loadRecentCommits();
            });
        }

        async function loadRepositoryTree(path = '') {
            const response = await fetch(`/gitlab/repository/${currentProjectId}/tree?branch=${currentBranch}&path=${path}`);
            const data = await response.json();
            
            const treeContainer = document.getElementById('file-tree');
            treeContainer.innerHTML = '';
            
            // Show current path
            document.getElementById('current-path').textContent = '/' + path;
            
            // Add back button if not at root
            if (path) {
                const backBtn = createTreeItem({
                    name: '..',
                    type: 'tree',
                    path: path.split('/').slice(0, -1).join('/')
                }, true);
                treeContainer.appendChild(backBtn);
            }
            
            // Sort items: directories first, then files
            const items = data.items.sort((a, b) => {
                if (a.type !== b.type) {
                    return a.type === 'tree' ? -1 : 1;
                }
                return a.name.localeCompare(b.name);
            });
            
            items.forEach(item => {
                const element = createTreeItem(item);
                treeContainer.appendChild(element);
            });
        }

        function createTreeItem(item, isBack = false) {
            const div = document.createElement('div');
            div.className = 'flex items-center p-2 hover:bg-gray-100 cursor-pointer rounded text-sm';
            
            const icon = item.type === 'tree' ? 'fas fa-folder text-blue-500' : getFileIcon(item.name);
            const name = isBack ? item.name : item.name;
            
            div.innerHTML = `
                <i class="${icon} mr-2 w-4"></i>
                <span class="truncate">${name}</span>
            `;
            
            div.addEventListener('click', async () => {
                if (item.type === 'tree') {
                    await loadRepositoryTree(item.path);
                } else {
                    await loadFileContent(item.path);
                }
            });
            
            return div;
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'py': 'fab fa-python text-blue-600',
                'js': 'fab fa-js-square text-yellow-500',
                'ts': 'fas fa-code text-blue-500',
                'html': 'fab fa-html5 text-orange-500',
                'css': 'fab fa-css3-alt text-blue-500',
                'json': 'fas fa-brackets-curly text-green-600',
                'md': 'fab fa-markdown text-gray-600',
                'yml': 'fas fa-file-code text-red-500',
                'yaml': 'fas fa-file-code text-red-500',
                'txt': 'fas fa-file-text text-gray-500'
            };
            return iconMap[ext] || 'fas fa-file text-gray-400';
        }

        async function loadFileContent(filePath) {
            try {
                const response = await fetch(`/gitlab/repository/${currentProjectId}/file?path=${encodeURIComponent(filePath)}&branch=${currentBranch}`);
                const data = await response.json();
                
                currentFile = data;
                document.getElementById('current-file-name').textContent = data.file_name;
                document.getElementById('file-actions').style.display = 'flex';
                
                const contentArea = document.getElementById('file-content-area');
                const language = getLanguageFromFilename(data.file_name);
                
                contentArea.innerHTML = `
                    <div class="bg-gray-50 border rounded-lg">
                        <div class="p-3 border-b bg-gray-100 text-sm text-gray-600">
                            <div class="flex justify-between items-center">
                                <span>${data.file_path}</span>
                                <span>${formatFileSize(data.size)}</span>
                            </div>
                        </div>
                        <pre id="code-content" class="p-4 overflow-x-auto"><code class="language-${language}">${escapeHtml(data.content)}</code></pre>
                    </div>
                `;
                
                // Highlight syntax
                Prism.highlightAll();
                
            } catch (error) {
                console.error('Error loading file:', error);
                alert('Error loading file: ' + error.message);
            }
        }

        async function loadRecentCommits() {
            const response = await fetch(`/gitlab/repository/${currentProjectId}/commits?branch=${currentBranch}&per_page=10`);
            const data = await response.json();
            
            const commitsContainer = document.getElementById('recent-commits');
            commitsContainer.innerHTML = '';
            
            data.commits.forEach(commit => {
                const commitElement = document.createElement('div');
                commitElement.className = 'border-l-4 border-blue-400 pl-3 py-2 hover:bg-gray-50 cursor-pointer';
                commitElement.innerHTML = `
                    <div class="text-sm font-medium text-gray-900 truncate">${commit.title}</div>
                    <div class="text-xs text-gray-500 mt-1">
                        <span>${commit.author_name}</span> • 
                        <span>${formatDate(commit.authored_date)}</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        <code>${commit.short_id}</code>
                    </div>
                `;
                
                commitElement.addEventListener('click', () => {
                    window.open(commit.web_url, '_blank');
                });
                
                commitsContainer.appendChild(commitElement);
            });
        }

        // AI Action Handlers
        document.getElementById('ai-review-btn').addEventListener('click', async () => {
            if (!currentFile) return;
            await performAIAction('review', 'Reviewing code for quality, security, and best practices...');
        });

        document.getElementById('ai-test-gen-btn').addEventListener('click', async () => {
            if (!currentFile) return;
            await performAIAction('test-generation', 'Generating comprehensive test cases...');
        });

        document.getElementById('ai-improve-btn').addEventListener('click', async () => {
            if (!currentFile) return;
            await performAIAction('improve', 'Analyzing code and suggesting improvements...');
        });

        async function performAIAction(action, loadingMessage) {
            const modal = document.getElementById('loading-modal');
            const resultsPanel = document.getElementById('ai-results-panel');
            const resultsContent = document.getElementById('ai-results-content');
            const codeContent = document.getElementById('code-content');
            
            modal.style.display = 'flex';
            modal.querySelector('p').textContent = loadingMessage;
            
            try {
                const response = await fetch('/api/ai-analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        file_path: currentFile.file_path,
                        content: currentFile.content,
                        project_id: currentProjectId,
                        branch: currentBranch
                    })
                });
                
                const result = await response.json();
                console.log('AI Analysis Result:', result);

                if (action === 'review' && result.analysis && result.analysis.suggested_changes) {
                    // Get the original code lines
                    let codeLines = currentFile.content.split('\n');
                    
                    // Apply the changes
                    for (const change of result.analysis.suggested_changes) {
                        if (change.line_number && change.new_content) {
                            codeLines[change.line_number - 1] = `<span class="bg-green-100">${escapeHtml(change.new_content)}</span>`;
                            if (change.old_content) {
                                codeLines.splice(change.line_number - 1, 0, 
                                    `<span class="bg-red-100 line-through">${escapeHtml(change.old_content)}</span>`);
                            }
                        }
                    }
                    
                    // Update the code view with changes highlighted
                    codeContent.innerHTML = `<code class="language-${getLanguageFromFilename(currentFile.file_name)}">${codeLines.join('\n')}</code>`;
                    Prism.highlightElement(codeContent.querySelector('code'));
                    
                    // Show a small notification with the number of changes
                    resultsContent.innerHTML = `
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                            <div class="text-sm text-blue-700">
                                <i class="fas fa-info-circle mr-2"></i>
                                Found ${result.analysis.suggested_changes.length} issue(s) in the code. Changes are highlighted above:
                                <ul class="list-disc list-inside mt-2">
                                    ${result.analysis.issues.map(issue => `<li>${issue}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    // Show success message if no changes needed
                    resultsContent.innerHTML = `
                        <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">
                            <div class="text-sm text-green-700">
                                <i class="fas fa-check-circle mr-2"></i>
                                Code looks good, no changes needed.
                            </div>
                        </div>
                    `;
                }
                
                resultsPanel.style.display = 'block';
                
            } catch (error) {
                console.error('AI analysis error:', error);
                resultsContent.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                        <div class="text-sm text-red-600">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            Error during analysis: ${error.message}
                        </div>
                    </div>
                `;
                resultsPanel.style.display = 'block';
            } finally {
                modal.style.display = 'none';
            }
        }

        // Utility functions
        function getLanguageFromFilename(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const langMap = {
                'py': 'python',
                'js': 'javascript',
                'ts': 'typescript',
                'html': 'html',
                'css': 'css',
                'json': 'json',
                'md': 'markdown',
                'yml': 'yaml',
                'yaml': 'yaml'
            };
            return langMap[ext] || 'text';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 24 * 60 * 60 * 1000) {
                return 'Today';
            } else if (diff < 7 * 24 * 60 * 60 * 1000) {
                return Math.floor(diff / (24 * 60 * 60 * 1000)) + ' days ago';
            } else {
                return date.toLocaleDateString();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initRepository);
    </script>
</body>
</html> 