<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository Browser - CI Code Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.30.1/min/vs/loader.min.js"></script>
    <style>
        #monaco-editor-container {
            width: 100%;
            height: 600px; /* Adjust as needed */
            border: 1px solid #ddd;
            border-radius: 0.375rem; /* Corresponds to rounded-lg */
        }
        
        .code-block {
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.4;
            tab-size: 4;
        }
        
        .code-block pre {
            margin: 0;
            padding: 8px;
            white-space: pre;
            overflow-x: auto;
        }
        
        .code-diff {
            display: flex;
            flex-direction: column;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin: 8px 0;
        }
        
        .code-diff-header {
            padding: 8px;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 500;
            color: #374151;
        }
        
        .code-diff-content {
            display: flex;
            flex-direction: column;
        }
        
        .code-diff-line {
            display: flex;
            align-items: flex-start;
            padding: 0 8px;
            min-height: 24px;
            position: relative;
        }
        
        .code-diff-line-number {
            width: 40px;
            padding-right: 8px;
            color: #6b7280;
            text-align: right;
            user-select: none;
        }
        
        .code-diff-line-content {
            flex: 1;
            padding: 0 8px;
            white-space: pre;
        }
        
        .code-diff-line.removed {
            background-color: #fee2e2;
        }
        
        .code-diff-line.removed .code-diff-line-content {
            color: #991b1b;
        }
        
        .code-diff-line.added {
            background-color: #dcfce7;
        }
        
        .code-diff-line.added .code-diff-line-content {
            color: #166534;
        }
        
        .code-diff-line-marker {
            width: 20px;
            padding: 0 4px;
            color: #6b7280;
            user-select: none;
        }
        
        .code-diff-line.removed .code-diff-line-marker {
            color: #991b1b;
        }
        
        .code-diff-line.added .code-diff-line-marker {
            color: #166534;
        }
        
        .change-actions {
            position: sticky;
            top: 0;
            background-color: white;
            padding: 8px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            z-index: 10;
        }
        
        .suggestion-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .suggestion-card-header {
            padding: 12px;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .suggestion-card-content {
            padding: 0;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <a href="/" class="text-2xl font-bold mr-6">
                    <i class="fas fa-robot mr-2"></i>
                    CI Code Companion
                </a>
                <div class="flex items-center space-x-4">
                    <i class="fab fa-gitlab text-lg"></i>
                    <span id="project-name">Loading...</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center bg-blue-700 px-3 py-1 rounded">
                    <i class="fas fa-code-branch mr-2"></i>
                    <select id="branch-selector" class="bg-transparent border-none text-white focus:outline-none">
                        <option>Loading...</option>
                    </select>
                </div>
                <a href="/" class="hover:bg-blue-700 px-3 py-1 rounded">
                    <i class="fas fa-home mr-1"></i>
                    Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Panel: File Tree -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-folder-tree mr-2 text-blue-600"></i>
                            Repository Tree
                        </h3>
                        <div class="text-sm text-gray-600 mt-1" id="current-path">
                            /
                        </div>
                    </div>
                    <div class="p-4">
                        <div id="file-tree" class="space-y-1">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading repository...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Commits Panel -->
                <div class="bg-white rounded-lg shadow-md mt-6">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-history mr-2 text-green-600"></i>
                            Recent Commits
                        </h3>
                    </div>
                    <div class="p-4">
                        <div id="recent-commits" class="space-y-3">
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading commits...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: File Content & AI Actions -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-file-code mr-2 text-gray-600"></i>
                                <span id="current-file-name" class="font-medium">Select a file to view</span>
                            </div>
                            <div class="flex items-center space-x-2" id="file-actions" style="display: none;">
                                <button id="ai-review-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-robot mr-1"></i>
                                    AI Review
                                </button>
                                <button id="ai-test-gen-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-vial mr-1"></i>
                                    Generate Tests
                                </button>
                                <button id="ai-improve-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-magic mr-1"></i>
                                    AI Improve
                                </button>
                                <button id="commit-push-btn" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1 rounded text-sm" style="display: none;">
                                    <i class="fas fa-upload mr-1"></i>
                                    Commit & Push
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div id="file-content-area">
                            <!-- Monaco Editor will be placed here -->
                            <div id="monaco-editor-container"></div> 
                             <div class="text-center py-12 text-gray-500" id="file-content-placeholder">
                                <i class="fas fa-file-code text-4xl mb-4"></i>
                                <p class="text-lg">Select a file from the repository tree to view its content</p>
                                <p class="text-sm mt-2">Use AI-powered tools to review, improve, and generate tests for your code</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Results Panel -->
                <div id="ai-results-panel" class="bg-white rounded-lg shadow-md mt-6" style="display: none;">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-robot mr-2 text-purple-600"></i>
                            AI Analysis Results
                        </h3>
                    </div>
                    <div class="p-4">
                        <div id="ai-results-content">
                            <!-- AI results will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" style="display: none;">
        <div class="bg-white rounded-lg p-6">
            <div class="text-center">
                <i class="fas fa-robot fa-spin text-4xl text-blue-600 mb-4"></i>
                <p class="text-lg font-medium">AI is analyzing your code...</p>
                <p class="text-sm text-gray-600 mt-2">This may take a few moments</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentProjectId = null;
        let currentBranch = null;
        let currentPath = '';
        let currentFile = null;
        let monacoEditor = null; // Monaco Editor instance

        // Initialize Monaco Editor paths
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.30.1/min/vs' }});

        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Function to create a diff view for code changes
        function createDiffView(oldContent, newContent) {
            const oldLines = oldContent.split('\n');
            const newLines = newContent.split('\n');
            
            let diffHtml = '<div class="code-diff">';
            
            // Add header
            diffHtml += `
                <div class="code-diff-header">
                    <div class="flex items-center justify-between">
                        <span>Code Change</span>
                        <span class="text-sm text-gray-500">${oldLines.length} line(s) → ${newLines.length} line(s)</span>
                    </div>
                </div>
                <div class="code-diff-content">
            `;
            
            // Add removed lines
            oldLines.forEach((line, i) => {
                diffHtml += `
                    <div class="code-diff-line removed">
                        <div class="code-diff-line-number">${i + 1}</div>
                        <div class="code-diff-line-marker">-</div>
                        <div class="code-diff-line-content">${escapeHtml(line)}</div>
                    </div>
                `;
            });
            
            // Add added lines
            newLines.forEach((line, i) => {
                diffHtml += `
                    <div class="code-diff-line added">
                        <div class="code-diff-line-number">${i + 1}</div>
                        <div class="code-diff-line-marker">+</div>
                        <div class="code-diff-line-content">${escapeHtml(line)}</div>
                    </div>
                `;
            });
            
            diffHtml += '</div></div>';
            return diffHtml;
        }

        // Initialize repository browser
        async function initRepository() {
            const urlParams = new URLSearchParams(window.location.search);
            currentProjectId = urlParams.get('project_id');
            
            if (!currentProjectId) {
                alert('No project selected');
                window.location.href = '/';
                return;
            }

            try {
                // Load project info and branches
                await loadProjectInfo();
                await loadBranches();
                await loadRepositoryTree();
                await loadRecentCommits();
            } catch (error) {
                console.error('Error initializing repository:', error);
                alert('Error loading repository: ' + error.message);
            }
        }

        async function loadProjectInfo() {
            const response = await fetch('/gitlab/projects');
            const projects = await response.json();
            const project = projects.find(p => p.id == currentProjectId);
            
            if (project) {
                document.getElementById('project-name').textContent = project.name;
                currentBranch = project.default_branch;
            }
        }

        async function loadBranches() {
            const response = await fetch(`/gitlab/repository/${currentProjectId}/branches`);
            const data = await response.json();
            
            const selector = document.getElementById('branch-selector');
            selector.innerHTML = '';
            
            data.branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.name;
                option.textContent = branch.name;
                if (branch.default) {
                    option.selected = true;
                    currentBranch = branch.name;
                }
                selector.appendChild(option);
            });

            selector.addEventListener('change', async (e) => {
                currentBranch = e.target.value;
                await loadRepositoryTree();
                await loadRecentCommits();
            });
        }

        async function loadRepositoryTree(path = '') {
            const response = await fetch(`/gitlab/repository/${currentProjectId}/tree?branch=${currentBranch}&path=${path}`);
            const data = await response.json();
            
            const treeContainer = document.getElementById('file-tree');
            treeContainer.innerHTML = '';
            
            // Show current path
            document.getElementById('current-path').textContent = '/' + path;
            
            // Add back button if not at root
            if (path) {
                const backBtn = createTreeItem({
                    name: '..',
                    type: 'tree',
                    path: path.split('/').slice(0, -1).join('/')
                }, true);
                treeContainer.appendChild(backBtn);
            }
            
            // Sort items: directories first, then files
            const items = data.items.sort((a, b) => {
                if (a.type !== b.type) {
                    return a.type === 'tree' ? -1 : 1;
                }
                return a.name.localeCompare(b.name);
            });
            
            items.forEach(item => {
                const element = createTreeItem(item);
                treeContainer.appendChild(element);
            });
        }

        function createTreeItem(item, isBack = false) {
            const div = document.createElement('div');
            div.className = 'flex items-center p-2 hover:bg-gray-100 cursor-pointer rounded text-sm';
            
            const icon = item.type === 'tree' ? 'fas fa-folder text-blue-500' : getFileIcon(item.name);
            const name = isBack ? item.name : item.name;
            
            div.innerHTML = `
                <i class="${icon} mr-2 w-4"></i>
                <span class="truncate">${name}</span>
            `;
            
            div.addEventListener('click', async () => {
                if (item.type === 'tree') {
                    await loadRepositoryTree(item.path);
                } else {
                    await loadFileContent(item.path);
                }
            });
            
            return div;
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'py': 'fab fa-python text-blue-600',
                'js': 'fab fa-js-square text-yellow-500',
                'ts': 'fas fa-code text-blue-500',
                'html': 'fab fa-html5 text-orange-500',
                'css': 'fab fa-css3-alt text-blue-500',
                'json': 'fas fa-brackets-curly text-green-600',
                'md': 'fab fa-markdown text-gray-600',
                'yml': 'fas fa-file-code text-red-500',
                'yaml': 'fas fa-file-code text-red-500',
                'txt': 'fas fa-file-text text-gray-500'
            };
            return iconMap[ext] || 'fas fa-file text-gray-400';
        }

        async function loadFileContent(filePath) {
            try {
                const response = await fetch(`/gitlab/repository/${currentProjectId}/file?path=${encodeURIComponent(filePath)}&branch=${currentBranch}`);
                const data = await response.json();
                
                currentFile = data;
                document.getElementById('current-file-name').textContent = data.file_name;
                document.getElementById('file-actions').style.display = 'flex';
                
                const editorContainer = document.getElementById('monaco-editor-container');
                const placeholder = document.getElementById('file-content-placeholder');
                
                // Hide placeholder, show editor
                if (placeholder) placeholder.style.display = 'none';
                editorContainer.style.display = 'block';

                // Dispose existing editor if any
                if (monacoEditor) {
                    monacoEditor.dispose();
                }

                require(['vs/editor/editor.main'], function() {
                    // Configure Monaco editor with diff support
                    monacoEditor = monaco.editor.create(editorContainer, {
                        value: data.content,
                        language: getMonacoLanguageFromFilename(data.file_name),
                        theme: 'vs-light',
                        readOnly: false,
                        automaticLayout: true,
                        minimap: { enabled: true },
                        renderLineHighlight: 'all',
                        lineNumbers: 'on',
                        scrollBeyondLastLine: false,
                        renderIndicators: true,
                        // Add diff-specific settings
                        diffDecorations: {
                            renderIndicators: true,
                            ignoreTrimWhitespace: false
                        }
                    });

                    // Store original content for diff comparison
                    monacoEditor.originalContent = data.content;

                    // Add change tracking
                    monacoEditor.onDidChangeModelContent(() => {
                        if (monacoEditor && currentFile) {
                            const newContent = monacoEditor.getValue();
                            const commitBtn = document.getElementById('commit-push-btn');
                            
                            if (newContent !== currentFile.content) {
                                commitBtn.style.display = 'inline-block';
                                // Add diff decorations
                                updateDiffDecorations(monacoEditor.originalContent, newContent);
                            } else {
                                commitBtn.style.display = 'none';
                                // Clear decorations if no changes
                                monacoEditor.deltaDecorations([], []);
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error('Error loading file:', error);
                alert('Error loading file: ' + error.message);
                const editorContainer = document.getElementById('monaco-editor-container');
                const placeholder = document.getElementById('file-content-placeholder');
                if (placeholder) placeholder.style.display = 'block';
                editorContainer.style.display = 'none';
            }
        }

        // Function to update diff decorations
        function updateDiffDecorations(originalContent, newContent) {
            if (!monacoEditor) return;

            const originalLines = originalContent.split('\n');
            const newLines = newContent.split('\n');
            const decorations = [];
            
            // Simple diff implementation
            let lineNumber = 1;
            for (let i = 0; i < Math.max(originalLines.length, newLines.length); i++) {
                const originalLine = originalLines[i] || '';
                const newLine = newLines[i] || '';
                
                if (originalLine !== newLine) {
                    if (!originalLine && newLine) {
                        // Added line
                        decorations.push({
                            range: new monaco.Range(lineNumber, 1, lineNumber, 1),
                            options: {
                                isWholeLine: true,
                                linesDecorationsClassName: 'diff-added-margin',
                                className: 'diff-added',
                                glyphMarginClassName: 'diff-added-glyph'
                            }
                        });
                    } else if (originalLine && !newLine) {
                        // Removed line
                        decorations.push({
                            range: new monaco.Range(lineNumber, 1, lineNumber, 1),
                            options: {
                                isWholeLine: true,
                                linesDecorationsClassName: 'diff-removed-margin',
                                className: 'diff-removed',
                                glyphMarginClassName: 'diff-removed-glyph'
                            }
                        });
                    } else {
                        // Modified line
                        decorations.push({
                            range: new monaco.Range(lineNumber, 1, lineNumber, 1),
                            options: {
                                isWholeLine: true,
                                linesDecorationsClassName: 'diff-modified-margin',
                                className: 'diff-modified',
                                glyphMarginClassName: 'diff-modified-glyph'
                            }
                        });
                    }
                }
                lineNumber++;
            }
            
            // Apply decorations
            monacoEditor.deltaDecorations([], decorations);
        }

        // Function to analyze code structure and determine proper indentation
        function analyzeCodeStructure(code) {
            const lines = code.split('\n');
            let indentLevel = 0;
            const indentSize = 4; // Default Python indentation
            const indentMap = new Map(); // Maps line numbers to required indent levels
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // Check for class or function definitions
                if (trimmedLine.startsWith('class ') || trimmedLine.startsWith('def ')) {
                    indentMap.set(i, indentLevel);
                    indentLevel++;
                    continue;
                }
                
                // Check for control structures that increase indent
                if (trimmedLine.endsWith(':')) {
                    indentMap.set(i, indentLevel);
                    indentLevel++;
                    continue;
                }
                
                // Check for empty lines
                if (trimmedLine === '') {
                    indentMap.set(i, indentLevel);
                    continue;
                }
                
                // Check for dedent markers
                if (trimmedLine.startsWith('return ') || 
                    trimmedLine.startsWith('break') || 
                    trimmedLine.startsWith('continue')) {
                    indentLevel = Math.max(0, indentLevel - 1);
                }
                
                indentMap.set(i, indentLevel);
            }
            
            return {
                indentMap,
                indentSize
            };
        }

        // Function to apply proper indentation to code
        function applyProperIndentation(code) {
            const { indentMap, indentSize } = analyzeCodeStructure(code);
            const lines = code.split('\n');
            
            return lines.map((line, index) => {
                const trimmedLine = line.trim();
                if (trimmedLine === '') return '';
                
                const indent = indentMap.get(index) || 0;
                return ' '.repeat(indent * indentSize) + trimmedLine;
            }).join('\n');
        }

        // Add styles for diff highlighting
        const style = document.createElement('style');
        style.textContent = `
            .diff-added { background-color: rgba(155, 255, 155, 0.2); }
            .diff-removed { background-color: rgba(255, 155, 155, 0.2); }
            .diff-modified { background-color: rgba(255, 255, 155, 0.2); }
            .diff-added-margin { border-left: 3px solid #28a745; }
            .diff-removed-margin { border-left: 3px solid #dc3545; }
            .diff-modified-margin { border-left: 3px solid #ffc107; }
            .diff-added-glyph:before { content: '+'; color: #28a745; margin-left: -20px; }
            .diff-removed-glyph:before { content: '-'; color: #dc3545; margin-left: -20px; }
            .diff-modified-glyph:before { content: '•'; color: #ffc107; margin-left: -20px; }
        `;
        document.head.appendChild(style);

        async function loadRecentCommits() {
            const response = await fetch(`/gitlab/repository/${currentProjectId}/commits?branch=${currentBranch}&per_page=10`);
            const data = await response.json();
            
            const commitsContainer = document.getElementById('recent-commits');
            commitsContainer.innerHTML = '';
            
            data.commits.forEach(commit => {
                const commitElement = document.createElement('div');
                commitElement.className = 'border-l-4 border-blue-400 pl-3 py-2 hover:bg-gray-50 cursor-pointer';
                commitElement.innerHTML = `
                    <div class="text-sm font-medium text-gray-900 truncate">${commit.title}</div>
                    <div class="text-xs text-gray-500 mt-1">
                        <span>${commit.author_name}</span> • 
                        <span>${formatDate(commit.authored_date)}</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        <code>${commit.short_id}</code>
                    </div>
                `;
                
                commitElement.addEventListener('click', () => {
                    window.open(commit.web_url, '_blank');
                });
                
                commitsContainer.appendChild(commitElement);
            });
        }

        // AI Action Handlers
        document.getElementById('ai-review-btn').addEventListener('click', async () => {
            if (!currentFile) return;
            await performAIAction('review', 'Reviewing code for quality, security, and best practices...');
        });

        document.getElementById('ai-test-gen-btn').addEventListener('click', async () => {
            if (!currentFile) return;
            await performAIAction('test-generation', 'Generating comprehensive test cases...');
        });

        document.getElementById('ai-improve-btn').addEventListener('click', async () => {
            if (!currentFile) return;
            await performAIAction('improve', 'Analyzing code and suggesting improvements...');
        });

        async function performAIAction(action, loadingMessage) {
            const modal = document.getElementById('loading-modal');
            const resultsPanel = document.getElementById('ai-results-panel');
            const resultsContent = document.getElementById('ai-results-content');
            
            modal.style.display = 'flex';
            const loadingModalText = modal.querySelector('p.text-lg.font-medium');
            if (loadingModalText) {
                loadingModalText.textContent = loadingMessage;
            }
            
            try {
                const response = await fetch('/api/ai-analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        file_path: currentFile.file_path,
                        content: monacoEditor ? monacoEditor.getValue() : currentFile.content,
                        project_id: currentProjectId,
                        branch: currentBranch,
                        language: getMonacoLanguageFromFilename(currentFile.file_name)
                    })
                });
                
                const result = await response.json();
                console.log('AI Analysis Result:', result);

                if (action === 'review' && result.analysis) {
                    let issues = result.analysis.issues || [];
                    let suggestedChanges = result.analysis.suggested_changes || [];

                    if (issues.length > 0 || suggestedChanges.length > 0) {
                        const issuesHtmlPromise = generateIssuesHtml(issues, suggestedChanges);
                        const issuesHtml = await issuesHtmlPromise;
                        resultsContent.innerHTML = issuesHtml;

                        // Store suggested changes in a global variable for later use
                        window.currentSuggestedChanges = suggestedChanges;

                        // Add event listener for "Apply All Changes" button
                        const applyAllBtn = document.getElementById('apply-all-changes-btn');
                        if (applyAllBtn) {
                            applyAllBtn.addEventListener('click', () => {
                                applyAllChanges(suggestedChanges);
                            });
                        }
                    } else {
                        resultsContent.innerHTML = `
                            <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">
                                <div class="text-sm text-green-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    No issues found. Code looks good!
                                </div>
                            </div>
                        `;
                    }
                } else if (result.error) {
                    resultsContent.innerHTML = `
                        <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                            <div class="text-sm text-red-600">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                Error during analysis: ${escapeHtml(result.error)}
                            </div>
                        </div>
                    `;
                }
                
                resultsPanel.style.display = 'block';
                
            } catch (error) {
                console.error('AI analysis error:', error);
                resultsContent.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                        <div class="text-sm text-red-600">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            Error during AI analysis: ${error.message}
                        </div>
                    </div>
                `;
                resultsPanel.style.display = 'block';
            } finally {
                modal.style.display = 'none';
            }
        }

        async function generateIssuesHtml(issues, suggestedChanges) {
            // Group suggestions by issue
            const suggestionsByIssue = new Map();
            issues.forEach((issue, index) => {
                suggestionsByIssue.set(index, suggestedChanges.filter(change => 
                    change.issue_index === index || change.related_issue === issue
                ));
            });

            let issuesHtml = `
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-code-branch text-blue-600 mr-2"></i>
                            Code Review Results
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Found ${issues.length} issue(s) with suggested improvements
                        </p>
                    </div>
                    <div class="divide-y divide-gray-200">
            `;

            // Create expandable sections for each issue
            for (let i = 0; i < issues.length; i++) {
                const issue = issues[i];
                const relatedChanges = suggestionsByIssue.get(i) || [];
                const hasChanges = relatedChanges.length > 0;

                issuesHtml += `
                    <div class="suggestion-card">
                        <div class="suggestion-card-header">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="inline-flex items-center justify-center h-6 w-6 rounded-full ${getSeverityBgClass(issue.severity)}">
                                        ${getSeverityIcon(issue.severity)}
                                    </span>
                                    <span class="font-medium">Issue #${i + 1}</span>
                                </div>
                                <span class="text-sm px-2 py-1 rounded ${getCategoryClass(issue.category)}">
                                    ${issue.category}
                                </span>
                            </div>
                            <p class="text-sm text-gray-700 mt-2">${escapeHtml(issue.description)}</p>
                        </div>
                        
                        <div class="suggestion-card-content">
                `;

                if (hasChanges) {
                    for (let j = 0; j < relatedChanges.length; j++) {
                        const change = relatedChanges[j];
                        const diffView = await createDiffView(change.old_content, change.new_content);

                        issuesHtml += `
                            <div class="border-t border-gray-200">
                                <div class="p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-sm font-medium text-gray-900">
                                            <i class="fas fa-code mr-2 text-blue-600"></i>
                                            Suggested Change ${j + 1}
                                        </h4>
                                        <button 
                                            class="apply-change-btn bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm"
                                            data-change-index="${i}-${j}"
                                            onclick="applySpecificChange(${i}, ${j})"
                                        >
                                            Apply Change
                                        </button>
                                    </div>
                                    
                                    ${diffView}
                                    
                                    ${change.explanation ? `
                                        <div class="mt-2 text-sm text-gray-600">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            ${escapeHtml(change.explanation)}
                                        </div>
                                    ` : ''}
                                    
                                    ${change.impact && change.impact.length > 0 ? `
                                        <div class="mt-2 flex flex-wrap gap-2">
                                            ${change.impact.map(impact => `
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    <i class="fas fa-impact mr-1"></i>
                                                    ${escapeHtml(impact)}
                                                </span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    issuesHtml += `
                        <div class="p-4 text-sm text-gray-500 italic">
                            No specific code changes suggested for this issue.
                        </div>
                    `;
                }

                issuesHtml += `
                        </div>
                    </div>
                `;
            }

            issuesHtml += `
                    </div>
                    ${suggestedChanges.length > 0 ? `
                        <div class="p-4 bg-gray-50 border-t border-gray-200">
                            <button id="apply-all-changes-btn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                                <i class="fas fa-check-circle mr-2"></i>
                                Apply All Changes
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            return issuesHtml;
        }

        function getSeverityBgClass(severity) {
            const classes = {
                'critical': 'bg-red-100 text-red-800',
                'high': 'bg-orange-100 text-orange-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'low': 'bg-green-100 text-green-800'
            };
            return classes[severity] || classes.medium;
        }

        function getSeverityIcon(severity) {
            const icons = {
                'critical': '<i class="fas fa-exclamation-triangle"></i>',
                'high': '<i class="fas fa-exclamation-circle"></i>',
                'medium': '<i class="fas fa-exclamation"></i>',
                'low': '<i class="fas fa-info-circle"></i>'
            };
            return icons[severity] || icons.medium;
        }

        function getCategoryClass(category) {
            const classes = {
                'security': 'bg-red-100 text-red-800',
                'performance': 'bg-blue-100 text-blue-800',
                'reliability': 'bg-yellow-100 text-yellow-800',
                'maintainability': 'bg-purple-100 text-purple-800',
                'style': 'bg-gray-100 text-gray-800'
            };
            return classes[category] || 'bg-gray-100 text-gray-800';
        }

        // Function to apply a specific change
        async function applySpecificChange(issueIndex, changeIndex) {
            const changes = window.currentSuggestedChanges;
            const change = changes.find(c => c.issue_index === issueIndex && c.change_index === changeIndex);
            
            if (!change || !monacoEditor) return;
            
            try {
                const model = monacoEditor.getModel();
                const lineNumber = parseInt(change.line_number, 10);
                
                // Get the current line's indentation
                const currentLine = model.getLineContent(lineNumber);
                const currentIndent = currentLine.match(/^\s*/)[0];
                
                // Calculate the range of lines to replace
                const oldLines = change.old_content.split('\n');
                const startLineNumber = lineNumber;
                const endLineNumber = lineNumber + oldLines.length - 1;
                
                // Apply proper indentation to new content
                const newLines = change.new_content.split('\n').map(line => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return '';
                    
                    const additionalIndent = calculateAdditionalIndent(trimmedLine, currentIndent.length / 4);
                    return currentIndent + '    '.repeat(additionalIndent) + trimmedLine;
                });
                
                // Create edit operation
                const edit = {
                    range: new monaco.Range(
                        startLineNumber,
                        1,
                        endLineNumber,
                        model.getLineMaxColumn(endLineNumber)
                    ),
                    text: newLines.join('\n')
                };
                
                // Apply the edit
                model.pushEditOperations([], [edit], () => null);
                
                // Update UI
                const button = document.querySelector(`button[data-change-index="${issueIndex}-${changeIndex}"]`);
                if (button) {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-500');
                    button.textContent = 'Applied';
                }
                
                // Show commit button
                document.getElementById('commit-push-btn').style.display = 'inline-block';
                
                // Update diff decorations
                updateDiffDecorations(monacoEditor.originalContent, model.getValue());
                
                // Add decorations for the changed lines
                const decorations = [];
                
                // Add decoration for removed lines
                decorations.push({
                    range: new monaco.Range(startLineNumber, 1, endLineNumber, 1),
                    options: {
                        isWholeLine: true,
                        className: 'removed-line-decoration',
                        glyphMarginClassName: 'removed-line-glyph'
                    }
                });
                
                // Add decoration for added lines
                const newLineCount = newLines.length;
                decorations.push({
                    range: new monaco.Range(startLineNumber, 1, startLineNumber + newLineCount - 1, 1),
                    options: {
                        isWholeLine: true,
                        className: 'added-line-decoration',
                        glyphMarginClassName: 'added-line-glyph'
                    }
                });
                
                // Apply decorations
                monacoEditor.deltaDecorations([], decorations);
            } catch (error) {
                console.error('Error applying change:', error);
            }
        }

        // Function to apply all changes
        async function applyAllChanges(changes) {
            if (!monacoEditor || !changes.length) return;
            
            try {
                const model = monacoEditor.getModel();
                const edits = [];
                
                // Sort changes by line number in descending order
                changes.sort((a, b) => parseInt(b.line_number) - parseInt(a.line_number));
                
                for (const change of changes) {
                    const lineNumber = parseInt(change.line_number, 10);
                    const currentLine = model.getLineContent(lineNumber);
                    const currentIndent = currentLine.match(/^\s*/)[0];
                    
                    const newLines = change.new_content.split('\n').map(line => {
                        const trimmedLine = line.trim();
                        if (!trimmedLine) return '';
                        
                        const additionalIndent = calculateAdditionalIndent(trimmedLine, currentIndent.length / 4);
                        return currentIndent + '    '.repeat(additionalIndent) + trimmedLine;
                    });
                    
                    edits.push({
                        range: new monaco.Range(
                            lineNumber,
                            1,
                            lineNumber + (change.old_content.split('\n').length - 1),
                            model.getLineMaxColumn(lineNumber + (change.old_content.split('\n').length - 1))
                        ),
                        text: newLines.join('\n')
                    });
                }
                
                // Apply all edits in one operation
                model.pushEditOperations([], edits, () => null);
                
                // Update UI
                const applyButtons = document.querySelectorAll('.apply-change-btn');
                applyButtons.forEach(button => {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-500');
                    button.textContent = 'Applied';
                });
                
                document.getElementById('apply-all-changes-btn').disabled = true;
                document.getElementById('apply-all-changes-btn').classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-500');
                document.getElementById('commit-push-btn').style.display = 'inline-block';
                
                // Update diff decorations
                updateDiffDecorations(monacoEditor.originalContent, model.getValue());
            } catch (error) {
                console.error('Error applying all changes:', error);
            }
        }

        function calculateAdditionalIndent(line, baseIndent) {
            let indent = 0;
            
            // Check for block starters
            if (line.match(/^(class|def|if|for|while|try|with|async|match)\b.*:$/)) {
                indent = 1;
            }
            // Check for continuation of previous block
            else if (line.match(/^(elif|else|except|finally)\b.*:$/)) {
                indent = 0;
            }
            // Check for nested function/method calls or list/dict comprehensions
            else if (line.match(/[\[\{\(].*[^\]\}\)]$/)) {
                indent = 1;
            }
            // Check for closing brackets/braces
            else if (line.match(/^[\]\}\)]/)) {
                indent = -1;
            }
            
            return Math.max(0, baseIndent + indent);
        }

        // Function to analyze code context
        function analyzeCodeContext(code, lineNumber) {
            const lines = code.split('\n');
            let contextIndent = 0;
            
            // Look at previous lines to determine context
            for (let i = lineNumber - 1; i >= 0; i--) {
                const line = lines[i].trim();
                if (line.endsWith(':')) {
                    contextIndent++;
                }
                // Look for class/method definitions
                if (line.startsWith('class ') || line.startsWith('def ')) {
                    contextIndent++;
                }
                // Look for dedents
                if (line.startsWith('return') || line.startsWith('break') || line.startsWith('continue')) {
                    contextIndent = Math.max(0, contextIndent - 1);
                }
            }
            
            return contextIndent;
        }

        // Utility functions
        function getLanguageFromFilename(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const langMap = {
                'py': 'python',
                'js': 'javascript',
                'ts': 'typescript',
                'html': 'html',
                'css': 'css',
                'json': 'json',
                'md': 'markdown',
                'yml': 'yaml',
                'yaml': 'yaml'
            };
            return langMap[ext] || 'text';
        }

        function getMonacoLanguageFromFilename(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            // Monaco has slightly different language IDs sometimes
            const langMap = {
                'py': 'python',
                'js': 'javascript',
                'ts': 'typescript',
                'html': 'html',
                'css': 'css',
                'json': 'json',
                'md': 'markdown',
                'yml': 'yaml',
                'yaml': 'yaml',
                'java': 'java',
                'c': 'c',
                'cpp': 'cpp',
                'cs': 'csharp',
                'go': 'go',
                'php': 'php',
                'rb': 'ruby',
                'rs': 'rust',
                'swift': 'swift',
                'sh': 'shell',
                'sql': 'sql',
                'xml': 'xml'
            };
            return langMap[ext] || 'plaintext'; // Default to plaintext
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 24 * 60 * 60 * 1000) {
                return 'Today';
            } else if (diff < 7 * 24 * 60 * 60 * 1000) {
                return Math.floor(diff / (24 * 60 * 60 * 1000)) + ' days ago';
            } else {
                return date.toLocaleDateString();
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initRepository);
    </script>
</body>
</html> 