<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository Browser - CI Code Companion</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/diff-viewer.css') }}">
    
    <!-- Scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>
    
    <style>
        :root {
            --sidebar-width: 320px;
            --header-height: 64px;
            --bottom-panel-height: 300px;
        }
        
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-layout {
            height: calc(100vh - var(--header-height));
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: 1fr;
            overflow: hidden;
        }
        
        .content-area {
            display: grid;
            grid-template-rows: 1fr auto var(--bottom-panel-height);
            min-height: 0;
            overflow: hidden;
        }
        
        .content-area.no-bottom-panel {
            grid-template-rows: 1fr auto;
        }
        
        .monaco-editor-area {
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            position: relative;
        }
        
        .monaco-editor-container-wrapper {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        .monaco-container {
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        .progress-sidebar {
            width: 350px;
            background: #1e293b;
            border-left: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 10;
        }
        
        .sidebar {
            background: #1e293b;
            color: #e2e8f0;
            overflow: hidden;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .tab-content {
            display: none;
            height: 100%;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .file-tree, .commits-list, .pr-list {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .file-tree-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .file-tree-item:hover {
            background-color: #334155;
        }
        
        .file-tree-item.selected {
            background-color: #3b82f6;
        }
        
        .file-tree-item .icon {
            width: 20px;
            margin-right: 8px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .commit-item {
            padding: 12px;
            border-bottom: 1px solid #334155;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .commit-item:hover {
            background-color: #334155;
        }
        
        .bottom-panel {
            background: #1e293b;
            color: #e2e8f0;
            border-top: 1px solid #334155;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .bottom-panel-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .ai-analysis-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            margin: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .severity-critical { border-left: 4px solid #ef4444; }
        .severity-high { border-left: 4px solid #f97316; }
        .severity-medium { border-left: 4px solid #eab308; }
        .severity-low { border-left: 4px solid #22c55e; }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: #334155;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .breadcrumb a {
            color: #60a5fa;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .search-box {
            background: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .action-button {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            outline: none;
            text-decoration: none;
            white-space: nowrap;
        }
        
        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        .btn-ai-review { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-ai-review:hover:not(:disabled) {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-ai-review:disabled {
            opacity: 0.8;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-test-gen { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            min-width: 160px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-test-gen:hover:not(:disabled) {
            background: linear-gradient(135deg, #0e8074 0%, #2dd968 100%);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
        }
        
        .btn-test-gen:disabled {
            opacity: 0.8;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-commit { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .btn-commit:hover {
            background: linear-gradient(135deg, #ff5252 0%, #d44638 100%);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }
        
        .resize-handle {
            background: #334155;
            cursor: row-resize;
            height: 4px;
            position: relative;
            flex-shrink: 0;
        }
        
        .resize-handle:hover {
            background: #3b82f6;
        }
        
        .sidebar-tabs {
            flex-shrink: 0;
        }
        
        .search-section {
            flex-shrink: 0;
        }
        
        .tab-header {
            flex-shrink: 0;
        }
        
        /* Ensure Monaco editor doesn't overflow */
        #monaco-editor-container {
            width: 100%;
            height: 100%;
        }
        
        /* Prevent text overflow in sidebar */
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Ensure proper scrolling in panels */
        .overflow-y-auto {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Header height constraint */
        header {
            height: var(--header-height);
            flex-shrink: 0;
        }
        
        /* AI Fix Highlight Styles */
        .ai-applied-fix-highlight {
            background-color: rgba(34, 197, 94, 0.2) !important;
            border: 1px solid #22c55e !important;
        }
        
        .ai-applied-fix-glyph {
            background-color: #22c55e !important;
            width: 3px !important;
        }
        
        /* Notification animation */
        .notification-enter {
            transform: translateX(100%);
        }
        
        .notification-enter-active {
            transform: translateX(0);
            transition: transform 0.3s ease-out;
        }
        
        .notification-exit {
            transform: translateX(0);
        }
        
        .notification-exit-active {
            transform: translateX(100%);
            transition: transform 0.3s ease-in;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100" x-data="repositoryBrowser()">
    <!-- Header -->
    <header class="bg-gray-800 shadow-lg h-16 flex items-center px-6 border-b border-gray-700">
        <div class="flex items-center flex-1">
            <!-- Logo and Project Name -->
            <div class="flex items-center">
                <a href="/" class="flex items-center text-xl font-bold mr-6 text-white hover:text-blue-400 transition-colors">
                    <i class="fas fa-code-branch text-green-500 mr-2"></i>
                    CI Code Companion
                </a>
                <div class="flex items-center space-x-4 text-gray-300">
                    <i class="fab fa-gitlab text-orange-500"></i>
                    <span x-text="projectName" class="font-medium">Loading...</span>
                    <span class="text-gray-500">/</span>
                    <div class="flex items-center bg-gray-700 px-3 py-1 rounded">
                        <i class="fas fa-code-branch mr-2 text-sm"></i>
                        <select x-model="currentBranch" @change="switchBranch()" class="bg-transparent text-white text-sm border-none outline-none">
                            <template x-for="branch in branches" :key="branch.name">
                                <option :value="branch.name" x-text="branch.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Header Actions -->
        <div class="flex items-center space-x-4">
            <!-- File Actions -->
            <div x-show="selectedFile" class="flex items-center space-x-3">
                <button @click="analyzeCode('review')" 
                        :disabled="loading"
                        class="action-button btn-ai-review">
                    <div class="flex items-center space-x-2">
                        <div x-show="!loading || analysisType !== 'review'" class="flex items-center space-x-2">
                            <i class="fas fa-robot text-lg"></i>
                            <span class="font-medium">AI Review</span>
                        </div>
                        <div x-show="loading && analysisType === 'review'" class="flex items-center space-x-2">
                            <div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                            <span class="font-medium">Analyzing...</span>
                        </div>
                    </div>
                </button>
                
                <button @click="analyzeCode('test')" 
                        :disabled="loading"
                        class="action-button btn-test-gen">
                    <div class="flex items-center space-x-2">
                        <div x-show="!loading || analysisType !== 'test'" class="flex items-center space-x-2">
                            <i class="fas fa-vial text-lg"></i>
                            <span class="font-medium">Generate Tests</span>
                        </div>
                        <div x-show="loading && analysisType === 'test'" class="flex items-center space-x-2">
                            <div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                            <span class="font-medium">Generating...</span>
                        </div>
                    </div>
                </button>
                
                <button x-show="hasChanges" @click="commitChanges()" class="action-button btn-commit">
                    <i class="fas fa-upload"></i>
                    Commit Changes
                </button>
                
                <!-- Debug Button (temporary) -->
                <button @click="loading = true; analysisType = 'review'; console.log('Debug: loading=', loading, 'analysisType=', analysisType)" 
                        class="action-button btn-secondary text-xs">
                    <i class="fas fa-bug"></i>
                    Test Sidebar
                </button>
            </div>
            
            <!-- Navigation -->
            <a href="/projects" class="action-button btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Projects
            </a>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Sidebar Tabs -->
            <div class="sidebar-tabs flex border-b border-gray-600">
                <button @click="activeTab = 'files'" 
                        :class="{'bg-blue-600': activeTab === 'files', 'bg-gray-700': activeTab !== 'files'}"
                        class="flex-1 px-4 py-3 text-sm font-medium">
                    <i class="fas fa-folder-tree mr-2"></i>
                    Files
                </button>
                <button @click="activeTab = 'commits'" 
                        :class="{'bg-blue-600': activeTab === 'commits', 'bg-gray-700': activeTab !== 'commits'}"
                        class="flex-1 px-4 py-3 text-sm font-medium">
                    <i class="fas fa-history mr-2"></i>
                    Commits
                </button>
                <button @click="activeTab = 'pullrequests'" 
                        :class="{'bg-blue-600': activeTab === 'pullrequests', 'bg-gray-700': activeTab !== 'pullrequests'}"
                        class="flex-1 px-4 py-3 text-sm font-medium">
                    <i class="fas fa-code-pull-request mr-2"></i>
                    PRs
                </button>
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Files Tab -->
                <div x-show="activeTab === 'files'" class="tab-content active">
                    <!-- Search -->
                    <div class="search-section p-4 border-b border-gray-600">
                        <input type="text" x-model="fileSearch" @input="filterFiles()" 
                               placeholder="Search files..." class="search-box">
                    </div>
                    
                    <!-- Breadcrumb -->
                    <div class="breadcrumb" x-show="currentPath">
                        <template x-for="(part, index) in pathParts" :key="index">
                            <span>
                                <a href="#" @click="navigateToPath(getPathUpTo(index))" x-text="part"></a>
                                <span x-show="index < pathParts.length - 1" class="mx-2 text-gray-500">/</span>
                            </span>
                        </template>
                    </div>
                    
                    <!-- File Tree -->
                    <div class="file-tree">
                        <template x-for="item in filteredFiles" :key="item.path">
                            <div @click="selectFile(item)" 
                                 :class="{'selected': selectedFile?.path === item.path}"
                                 class="file-tree-item">
                                <i :class="getFileIcon(item)" class="icon"></i>
                                <span x-text="item.name" class="flex-1 truncate"></span>
                                <span x-show="item.type === 'tree'" class="text-xs text-gray-400">
                                    <i class="fas fa-chevron-right"></i>
                                </span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Commits Tab -->
                <div x-show="activeTab === 'commits'" class="tab-content">
                    <div class="tab-header p-4 border-b border-gray-600">
                        <h3 class="font-medium mb-2">Recent Commits</h3>
                        <div class="flex items-center space-x-2 text-sm text-gray-400">
                            <span x-text="commits.length">0</span>
                            <span>commits on</span>
                            <span x-text="currentBranch">main</span>
                        </div>
                    </div>
                    
                    <div class="commits-list">
                        <template x-for="commit in commits" :key="commit.id">
                            <div class="commit-item" @click="viewCommit(commit)">
                                <div class="flex items-start space-x-3">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mt-2 flex-shrink-0"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-sm truncate" x-text="commit.title"></div>
                                        <div class="text-xs text-gray-400 mt-1">
                                            <span x-text="commit.author_name"></span>
                                            <span class="mx-1">•</span>
                                            <span x-text="formatDate(commit.authored_date)"></span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1 font-mono" x-text="commit.short_id"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Pull Requests Tab -->
                <div x-show="activeTab === 'pullrequests'" class="tab-content">
                    <div class="tab-header p-4 border-b border-gray-600">
                        <h3 class="font-medium mb-2">Pull Requests</h3>
                        <div class="flex space-x-2 text-sm">
                            <button @click="prFilter = 'open'" 
                                    :class="{'text-blue-400': prFilter === 'open', 'text-gray-400': prFilter !== 'open'}"
                                    class="hover:text-blue-300">
                                Open (<span x-text="pullRequests.filter(pr => pr.state === 'opened').length">0</span>)
                            </button>
                            <button @click="prFilter = 'merged'" 
                                    :class="{'text-blue-400': prFilter === 'merged', 'text-gray-400': prFilter !== 'merged'}"
                                    class="hover:text-blue-300">
                                Merged (<span x-text="pullRequests.filter(pr => pr.state === 'merged').length">0</span>)
                            </button>
                        </div>
                    </div>
                    
                    <div class="pr-list">
                        <template x-for="pr in filteredPullRequests" :key="pr.id">
                            <div class="commit-item" @click="viewPullRequest(pr)">
                                <div class="flex items-start space-x-3">
                                    <div :class="getPRIcon(pr.state)" class="mt-1 flex-shrink-0"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-sm truncate" x-text="pr.title"></div>
                                        <div class="text-xs text-gray-400 mt-1">
                                            <span x-text="pr.author.name"></span>
                                            <span class="mx-1">•</span>
                                            <span x-text="formatDate(pr.created_at)"></span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <span x-text="pr.source_branch"></span>
                                            <i class="fas fa-arrow-right mx-1"></i>
                                            <span x-text="pr.target_branch"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area" :class="{'no-bottom-panel': !showBottomPanel}">
            <!-- Monaco Editor Area -->
            <div class="monaco-editor-area relative bg-gray-800">
                <!-- File Header -->
                <div x-show="selectedFile" class="bg-gray-700 px-6 py-3 border-b border-gray-600 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center space-x-3">
                        <i :class="getFileIcon(selectedFile)" class="text-lg"></i>
                        <span class="font-medium" x-text="selectedFile?.name">Select a file</span>
                        <span x-show="selectedFile" class="text-sm text-gray-400 truncate" x-text="selectedFile?.path"></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span x-show="fileSize" class="text-xs text-gray-400" x-text="fileSize"></span>
                        <span x-show="selectedFile" class="text-xs text-gray-400" x-text="getFileLanguage(selectedFile)"></span>
                    </div>
                </div>

                <!-- Monaco Editor Container -->
                <div class="monaco-editor-container-wrapper">
                    <div id="monaco-editor-container" class="monaco-container"></div>
                    
                    <!-- Progress Sidebar -->
                    <div x-show="loading && analysisType" 
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="transform translate-x-full"
                         x-transition:enter-end="transform translate-x-0"
                         x-transition:leave="transition ease-in duration-300"
                         x-transition:leave-start="transform translate-x-0"
                         x-transition:leave-end="transform translate-x-full"
                         class="progress-sidebar">
                        
                        <!-- Debug Info -->
                        <div class="hidden" x-data x-text="console.log('Progress sidebar visible:', loading, analysisType)"></div>
                        
                        <!-- Progress Header -->
                        <div class="p-4 border-b border-gray-600">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                        <i class="fas fa-robot text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-white">AI Analysis</h3>
                                        <p class="text-sm text-gray-400" x-text="getAnalysisMessage()"></p>
                                    </div>
                                </div>
                                <!-- Close Button -->
                                <button @click="loading = false; analysisType = null;" 
                                        class="text-gray-400 hover:text-white transition-colors p-1 rounded hover:bg-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-3">
                                <div class="flex justify-between text-sm text-gray-400 mb-1">
                                    <span>Progress</span>
                                    <span x-text="Math.round(analysisProgress) + '%'"></span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300" 
                                         :style="'width: ' + analysisProgress + '%'"></div>
                                </div>
                            </div>
                            
                            <!-- Current Step -->
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="flex items-center space-x-2">
                                    <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-cog fa-spin text-white text-sm"></i>
                                    </div>
                                    <div class="text-left">
                                        <div class="font-medium text-white" x-text="currentStep.title"></div>
                                        <div class="text-sm text-gray-400" x-text="currentStep.description"></div>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs text-gray-500" x-text="'Elapsed: ' + formatElapsedTime(analysisStartTime)"></div>
                            </div>
                        </div>
                        
                        <!-- Analysis Steps -->
                        <div class="p-4 space-y-3 flex-1">
                            <h4 class="font-medium text-white text-sm mb-3">Analysis Steps</h4>
                            <template x-for="(step, index) in analysisSteps" :key="index">
                                <div class="flex items-center space-x-3 text-sm p-2 rounded-lg" 
                                     :class="step.status === 'completed' ? 'bg-green-900 text-green-200' : 
                                             step.status === 'active' ? 'bg-blue-900 text-blue-200' : 'bg-gray-700 text-gray-400'">
                                    <div class="w-5 h-5 flex items-center justify-center">
                                        <i x-show="step.status === 'completed'" class="fas fa-check-circle text-green-400"></i>
                                        <i x-show="step.status === 'active'" class="fas fa-circle-notch fa-spin text-blue-400"></i>
                                        <i x-show="step.status === 'pending'" class="far fa-circle text-gray-500"></i>
                                    </div>
                                    <span class="flex-1" x-text="step.name"></span>
                                    <div x-show="step.status === 'completed' && step.result" class="text-xs bg-gray-600 px-2 py-1 rounded" x-text="step.result"></div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Real-time Issues Found -->
                        <div x-show="realTimeIssues.length > 0" class="p-4 border-t border-gray-600">
                            <h4 class="font-medium text-white text-sm mb-3 flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>
                                Issues Found (<span x-text="realTimeIssues.length"></span>)
                            </h4>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                <template x-for="issue in realTimeIssues" :key="issue.id">
                                    <div class="bg-gray-700 p-2 rounded text-xs">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <div :class="'w-2 h-2 rounded-full ' + getSeverityColor(issue.severity)"></div>
                                            <span class="font-medium text-white" x-text="issue.title"></span>
                                        </div>
                                        <div class="text-gray-400" x-text="issue.preview"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="p-4 border-t border-gray-600">
                            <div class="grid grid-cols-2 gap-3 text-center">
                                <div class="bg-gray-700 rounded-lg p-2">
                                    <div class="text-lg font-bold text-red-400" x-text="analysisStats.issuesFound"></div>
                                    <div class="text-xs text-gray-400">Issues</div>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-2">
                                    <div class="text-lg font-bold text-green-400" x-text="analysisStats.suggestions"></div>
                                    <div class="text-xs text-gray-400">Solutions</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div x-show="!selectedFile" class="absolute inset-0 flex items-center justify-center text-gray-500">
                    <div class="text-center">
                        <i class="fas fa-file-code text-6xl mb-4 text-gray-600"></i>
                        <h3 class="text-xl font-medium mb-2">Select a file to view</h3>
                        <p class="text-gray-400">Choose a file from the repository tree to start editing</p>
                    </div>
                </div>

                <!-- Loading Overlay -->
                <div x-show="loading && !analysisType" class="loading-overlay">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                        <p class="text-white" x-text="loadingMessage">Loading...</p>
                    </div>
                </div>
                
                <!-- AI Analysis Thinking Overlay -->
                <!-- Overlay removed - now using compact progress sidebar on the right -->
            </div>

            <!-- Resize Handle -->
            <div x-show="showBottomPanel" class="resize-handle" @mousedown="startResize($event)"></div>

            <!-- Bottom Panel - AI Analysis -->
            <div x-show="showBottomPanel" class="bottom-panel">
                <!-- Bottom Panel Tabs -->
                <div class="flex border-b border-gray-600 bg-gray-800 flex-shrink-0">
                    <button @click="bottomTab = 'analysis'" 
                            :class="{'bg-blue-600': bottomTab === 'analysis', 'bg-gray-700': bottomTab !== 'analysis'}"
                            class="px-4 py-3 text-sm font-medium">
                        <i class="fas fa-robot mr-2"></i>
                        AI Analysis
                        <span x-show="analysisResults.length" class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full" x-text="analysisResults.length"></span>
                    </button>
                    <button @click="bottomTab = 'suggestions'" 
                            :class="{'bg-blue-600': bottomTab === 'suggestions', 'bg-gray-700': bottomTab !== 'suggestions'}"
                            class="px-4 py-3 text-sm font-medium">
                        <i class="fas fa-lightbulb mr-2"></i>
                        Suggestions
                        <span x-show="suggestions.length" class="ml-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded-full" x-text="suggestions.length"></span>
                    </button>
                    <button @click="bottomTab = 'tests'" 
                            :class="{'bg-blue-600': bottomTab === 'tests', 'bg-gray-700': bottomTab !== 'tests'}"
                            class="px-4 py-3 text-sm font-medium">
                        <i class="fas fa-vial mr-2"></i>
                        Generated Tests
                        <span x-show="generatedTests && generatedTests.test_code" class="ml-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">1</span>
                    </button>
                    
                    <!-- Close Button -->
                    <div class="ml-auto flex items-center">
                        <button @click="showBottomPanel = false" class="p-3 hover:bg-gray-600 text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Bottom Panel Content -->
                <div class="bottom-panel-content">
                    <!-- Analysis Results -->
                    <div x-show="bottomTab === 'analysis'" class="p-4">
                        <template x-for="result in analysisResults" :key="result.id">
                            <div :class="'ai-analysis-card severity-' + result.severity">
                                <div class="p-4">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex items-center space-x-2">
                                            <i :class="getSeverityIcon(result.severity)" class="text-lg"></i>
                                            <h4 class="font-medium" x-text="result.title"></h4>
                                            <span :class="getSeverityBadge(result.severity)" 
                                                  class="px-2 py-1 text-xs rounded-full" 
                                                  x-text="result.severity.toUpperCase()"></span>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button @click="viewDiff(result)" 
                                                    x-show="result.suggestedFix && result.oldContent"
                                                    class="action-button btn-secondary text-xs">
                                                <i class="fas fa-eye"></i>
                                                View Diff
                                            </button>
                                            <button @click="applyFix(result)" 
                                                    x-show="result.suggestedFix"
                                                    class="action-button btn-primary text-xs">
                                                <i class="fas fa-magic"></i>
                                                Apply Fix
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <p class="text-gray-300 mb-3" x-text="result.description"></p>
                                    
                                    <!-- Line Number Info -->
                                    <div x-show="result.lineNumber" class="text-xs text-gray-400 mb-3 flex items-center">
                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                        <span>Line </span>
                                        <span x-text="result.lineNumber"></span>
                                        <span class="ml-2 text-gray-500">•</span>
                                        <span class="ml-2" x-text="result.category || 'Code Quality'"></span>
                                    </div>
                                    
                                    <!-- Code Diff Viewer -->
                                    <div x-show="result.showDiff" class="mb-4">
                                        <div class="bg-gray-900 rounded-lg overflow-hidden border border-gray-600">
                                            <!-- Diff Header -->
                                            <div class="bg-gray-800 px-4 py-2 border-b border-gray-600 flex items-center justify-between">
                                                <span class="text-sm font-medium text-gray-300">Code Changes</span>
                                                <button @click="result.showDiff = false" class="text-gray-400 hover:text-white">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            
                                            <!-- Before Code -->
                                            <div x-show="result.oldContent" class="border-b border-gray-600">
                                                <div class="bg-red-900 bg-opacity-20 px-4 py-2 border-b border-red-800">
                                                    <span class="text-red-400 text-sm font-medium">
                                                        <i class="fas fa-minus mr-2"></i>Before
                                                    </span>
                                                </div>
                                                <pre class="p-4 text-sm font-mono text-red-200 bg-red-900 bg-opacity-10 overflow-x-auto" x-text="result.oldContent"></pre>
                                            </div>
                                            
                                            <!-- After Code -->
                                            <div x-show="result.suggestedFix">
                                                <div class="bg-green-900 bg-opacity-20 px-4 py-2 border-b border-green-800">
                                                    <span class="text-green-400 text-sm font-medium">
                                                        <i class="fas fa-plus mr-2"></i>After (Suggested Fix)
                                                    </span>
                                                </div>
                                                <pre class="p-4 text-sm font-mono text-green-200 bg-green-900 bg-opacity-10 overflow-x-auto" x-text="result.suggestedFix"></pre>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Recommendation -->
                                    <div x-show="result.recommendation" class="bg-blue-900 bg-opacity-20 border border-blue-800 rounded p-3 text-sm">
                                        <div class="flex items-start space-x-2">
                                            <i class="fas fa-lightbulb text-blue-400 mt-0.5"></i>
                                            <div>
                                                <div class="font-medium text-blue-300 mb-1">Recommendation</div>
                                                <div class="text-blue-200" x-text="result.recommendation"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="analysisResults.length === 0" class="text-center py-8 text-gray-500">
                            <i class="fas fa-robot text-4xl mb-3"></i>
                            <p>No analysis results yet. Run AI analysis on a file to see results here.</p>
                        </div>
                    </div>

                    <!-- Suggestions -->
                    <div x-show="bottomTab === 'suggestions'" class="p-4">
                        <!-- Suggestions content will go here -->
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-lightbulb text-4xl mb-3"></i>
                            <p>AI suggestions will appear here when available.</p>
                        </div>
                    </div>

                    <!-- Generated Tests -->
                    <div x-show="bottomTab === 'tests'" class="p-4">
                        <div x-show="generatedTests && generatedTests.test_code" class="space-y-4">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-medium text-green-400">
                                        <i class="fas fa-vial mr-2"></i>
                                        Generated Test Code
                                    </h4>
                                    <button @click="copyTestCode()" class="action-button btn-primary text-xs">
                                        <i class="fas fa-copy"></i>
                                        Copy Code
                                    </button>
                                </div>
                                <pre class="bg-gray-900 p-3 rounded text-sm font-mono overflow-x-auto text-green-300" x-text="generatedTests.test_code"></pre>
                            </div>
                            
                            <div x-show="generatedTests.explanation" class="bg-gray-800 rounded-lg p-4">
                                <h4 class="font-medium text-blue-400 mb-2">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Test Explanation
                                </h4>
                                <p class="text-gray-300 text-sm" x-text="generatedTests.explanation"></p>
                            </div>
                            
                            <div x-show="generatedTests.coverage_areas && generatedTests.coverage_areas.length" class="bg-gray-800 rounded-lg p-4">
                                <h4 class="font-medium text-purple-400 mb-2">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    Coverage Areas
                                </h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    <template x-for="area in generatedTests.coverage_areas" :key="area">
                                        <li x-text="area"></li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Empty state -->
                        <div x-show="!generatedTests || !generatedTests.test_code" class="text-center py-8 text-gray-500">
                            <i class="fas fa-vial text-4xl mb-3"></i>
                            <p>No tests generated yet. Click "Generate Tests" to create test cases for your code.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alpine.js Data and Monaco Editor Script -->
    <script>
        function repositoryBrowser() {
            return {
                // Data
                projectId: null,
                projectName: 'Loading...',
                currentBranch: 'main',
                branches: [],
                currentPath: '',
                fileTree: [],
                filteredFiles: [],
                fileSearch: '',
                selectedFile: null,
                fileSize: '',
                commits: [],
                pullRequests: [],
                loading: false,
                loadingMessage: 'Loading...',
                hasChanges: false,
                
                // UI State
                activeTab: 'files',
                bottomTab: 'analysis',
                showBottomPanel: false,
                prFilter: 'open',
                analysisType: null,
                analysisStep: 1,
                
                // Progress tracking
                analysisProgress: 0,
                analysisStartTime: null,
                currentStep: { title: '', description: '' },
                analysisSteps: [],
                currentInsights: [],
                analysisStats: { issuesFound: 0, linesAnalyzed: 0, suggestions: 0 },
                realTimeIssues: [],
                
                // AI Analysis
                analysisResults: [],
                suggestions: [],
                generatedTests: null,
                
                // Monaco Editor
                monacoEditor: null,
                
                init() {
                    console.log('=== Repository Browser Initializing ===');
                    try {
                        this.initFromURL();
                        this.loadProject();
                        console.log('Repository Browser initialized successfully');
                    } catch (error) {
                        console.error('Error initializing Repository Browser:', error);
                    }
                },
                
                initFromURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.projectId = urlParams.get('project_id');
                    this.projectName = urlParams.get('name') || 'Unknown Project';
                    
                    if (!this.projectId) {
                        alert('No project selected');
                        window.location.href = '/projects';
                        return;
                    }
                },
                
                async loadProject() {
                    try {
                        this.loading = true;
                        this.loadingMessage = 'Loading project...';
                        
                        await Promise.all([
                            this.loadBranches(),
                            this.loadFileTree(),
                            this.loadCommits(),
                            this.loadPullRequests()
                        ]);
                        
                        this.loading = false;
                    } catch (error) {
                        console.error('Error loading project:', error);
                        alert('Error loading project: ' + error.message);
                        this.loading = false;
                    }
                },
                
                async loadBranches() {
                    try {
                        const response = await fetch(`/gitlab/repository/${this.projectId}/branches`);
                        const data = await response.json();
                        this.branches = data.branches;
                        this.currentBranch = data.default_branch || 'main';
                    } catch (error) {
                        console.error('Error loading branches:', error);
                    }
                },
                
                async loadFileTree(path = '') {
                    try {
                        const response = await fetch(`/gitlab/repository/${this.projectId}/tree?branch=${this.currentBranch}&path=${path}`);
                        const data = await response.json();
                        this.fileTree = data.items.sort((a, b) => {
                            if (a.type !== b.type) return a.type === 'tree' ? -1 : 1;
                            return a.name.localeCompare(b.name);
                        });
                        this.filteredFiles = this.fileTree;
                        this.currentPath = path;
                    } catch (error) {
                        console.error('Error loading file tree:', error);
                    }
                },
                
                async loadCommits() {
                    try {
                        const response = await fetch(`/gitlab/repository/${this.projectId}/commits?branch=${this.currentBranch}&per_page=20`);
                        const data = await response.json();
                        this.commits = data.commits;
                    } catch (error) {
                        console.error('Error loading commits:', error);
                    }
                },
                
                async loadPullRequests() {
                    try {
                        // For now, using mock data - replace with actual GitLab API
                        this.pullRequests = [
                            {
                                id: 1,
                                title: 'Feature: Add user authentication',
                                state: 'opened',
                                author: { name: 'John Doe' },
                                created_at: new Date().toISOString(),
                                source_branch: 'feature/auth',
                                target_branch: 'main'
                            },
                            {
                                id: 2,
                                title: 'Fix: Memory leak in background worker',
                                state: 'merged',
                                author: { name: 'Jane Smith' },
                                created_at: new Date(Date.now() - 86400000).toISOString(),
                                source_branch: 'fix/memory-leak',
                                target_branch: 'main'
                            }
                        ];
                    } catch (error) {
                        console.error('Error loading pull requests:', error);
                    }
                },
                
                // File operations
                filterFiles() {
                    if (!this.fileSearch) {
                        this.filteredFiles = this.fileTree;
                        return;
                    }
                    
                    this.filteredFiles = this.fileTree.filter(item =>
                        item.name.toLowerCase().includes(this.fileSearch.toLowerCase())
                    );
                },
                
                async selectFile(item) {
                    if (item.type === 'tree') {
                        await this.loadFileTree(item.path);
                        return;
                    }
                    
                    try {
                        this.loading = true;
                        this.loadingMessage = 'Loading file...';
                        
                        const response = await fetch(`/gitlab/repository/${this.projectId}/file?path=${encodeURIComponent(item.path)}&branch=${this.currentBranch}`);
                        const fileData = await response.json();
                        
                        this.selectedFile = {
                            ...item,
                            content: fileData.content,
                            size: fileData.size
                        };
                        
                        this.fileSize = this.formatFileSize(fileData.size);
                        this.initMonacoEditor(fileData.content, item.name);
                        
                        this.loading = false;
                    } catch (error) {
                        console.error('Error loading file:', error);
                        alert('Error loading file: ' + error.message);
                        this.loading = false;
                    }
                },
                
                initMonacoEditor(content, filename) {
                    const container = document.getElementById('monaco-editor-container');
                    
                    // Dispose existing editor
                    if (this.monacoEditor) {
                        this.monacoEditor.dispose();
                    }
                    
                    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
                    
                    require(['vs/editor/editor.main'], () => {
                        this.monacoEditor = monaco.editor.create(container, {
                            value: content,
                            language: this.getMonacoLanguage(filename),
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: true },
                            renderLineHighlight: 'all',
                            lineNumbers: 'on',
                            scrollBeyondLastLine: false,
                            wordWrap: 'on'
                        });
                        
                        // Track changes
                        this.monacoEditor.onDidChangeModelContent(() => {
                            const newContent = this.monacoEditor.getValue();
                            this.hasChanges = newContent !== this.selectedFile.content;
                        });
                    });
                },
                
                // Simple test version
                testAnalyze(type) {
                    console.log('=== testAnalyze called ===');
                    console.log('Type:', type);
                    alert(`Test analyze called with type: ${type}`);
                },
                
                // AI Analysis
                async analyzeCode(type) {
                    console.log('[1] analyzeCode START');
                    
                    if (!this.selectedFile) {
                        console.error('[1.1] No selectedFile');
                        alert('Please select a file first.');
                        return;
                    }
                    if (!this.monacoEditor) {
                        console.error('[1.2] No monacoEditor instance');
                        alert('Editor not initialized. Please wait or refresh.');
                        return;
                    }
                    console.log('[2] Checks passed');

                    this.loading = true;
                    this.analysisType = type;
                    this.loadingMessage = `Running AI ${type} analysis...`;
                    
                    // Initialize progress tracking
                    this.initializeProgress(type);
                    console.log('[3] Progress tracking initialized');

                    let content;
                    try {
                        console.log('[4] Trying monacoEditor.getValue()');
                        
                        // Simulate step progression
                        await this.simulateStepDelay(0, 'File content extracted');
                        
                        const rawEditor = Alpine.raw(this.monacoEditor);
                        if (rawEditor && typeof rawEditor.getValue === 'function') {
                            content = rawEditor.getValue();
                            console.log('[5] rawEditor.getValue() SUCCEEDED. Content length:', content?.length);
                            this.completeStep(0, `${content.split('\n').length} lines`);
                        } else {
                            throw new Error('Raw editor not ready or getValue not available.');
                        }
                    } catch (e) {
                        console.error('[5.E] rawEditor.getValue() FAILED with exception:', e);
                        alert('Error getting content from editor. See console.');
                        this.loading = false;
                        this.analysisType = null;
                        return;
                    }

                    try {
                        console.log('[6] Starting API call to /api/ai-analyze');
                        
                        // Simulate parsing step
                        await this.simulateStepDelay(1, 'Code structure analyzed');
                        this.completeStep(1, 'AST generated');
                        
                        // Simulate pattern analysis
                        await this.simulateStepDelay(2, 'Patterns identified');
                        this.completeStep(2, 'Syntax validated');
                        
                        const languageForPayload = 'Python';
                        const apiRequestBody = {
                            action: type,
                            file_path: this.selectedFile.path,
                            content: content,
                            project_id: this.projectId,
                            branch: this.currentBranch,
                            language: languageForPayload
                        };

                        // Simulate security check
                        await this.simulateStepDelay(3, 'Security scan complete');
                        this.completeStep(3, 'No critical vulnerabilities');

                        const response = await fetch('/api/ai-analyze', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(apiRequestBody)
                        });

                        if (!response.ok) {
                            console.error('[7.1] API response NOT OK');
                            let errorText = `HTTP error ${response.status}`;
                            try {
                                const errData = await response.json();
                                errorText = errData.error || JSON.stringify(errData);
                            } catch (jsonErr) {
                                console.error('[7.5] Could not parse error response as JSON:', jsonErr);
                            }
                            throw new Error(errorText);
                        }

                        // Simulate remaining steps while processing response
                        await this.simulateStepDelay(4, 'Performance analysis complete');
                        this.completeStep(4, 'Optimization opportunities found');
                        
                        await this.simulateStepDelay(5, 'Quality evaluation complete');
                        this.completeStep(5, 'Best practices assessed');

                        const result = await response.json();
                        console.log('[9] response.json() SUCCEEDED:', result);

                        // Simulate final steps
                        await this.simulateStepDelay(6, 'Generating recommendations');
                        this.completeStep(6, 'Suggestions created');
                        
                        await this.simulateStepDelay(7, 'Analysis finalized');
                        this.completeStep(7, 'Results ready');

                        if (type === 'review' && result.analysis) {
                            this.analysisResults = this.processReviewResults(result.analysis);
                            this.bottomTab = 'analysis';
                            
                            // Update final stats
                            this.analysisStats.issuesFound = this.analysisResults.length;
                            this.analysisStats.suggestions = this.analysisResults.filter(r => r.suggestedFix).length;
                            
                        } else if (type === 'test' && result.tests) {
                            this.generatedTests = result.tests;
                            this.bottomTab = 'tests';
                        } else {
                            console.warn('[9.1] Unexpected API result format');
                        }
                        this.showBottomPanel = true;
                        console.log('[10] Analysis processed SUCCESSFULLY');

                    } catch (error) {
                        console.error('[11.E] Error during API call or processing:', error);
                        alert(`Error: ${error.message}. Using fallback data.`);
                        
                        if (type === 'review') {
                            this.analysisResults = this.getMockReviewResults();
                            this.bottomTab = 'analysis';
                        } else {
                            this.generatedTests = this.getMockTestResults();
                            this.bottomTab = 'tests';
                        }
                        this.showBottomPanel = true;
                        console.log('[11.1] Fallback data applied');
                        
                    } finally {
                        console.log('[12] FINALLY block');
                        
                        // Complete all remaining steps to show full progress
                        this.analysisProgress = 100;
                        this.currentStep = {
                            title: 'Analysis Complete',
                            description: 'Processing results and generating recommendations'
                        };
                        
                        // Show completion for 3 seconds before hiding sidebar
                        setTimeout(() => {
                            this.loading = false;
                            this.analysisType = null;
                            console.log('[13] Loading state CLEARED');
                        }, 3000); // Increased from 1000ms to 3000ms for better UX
                    }
                },
                
                // Helper method for realistic step delays
                async simulateStepDelay(stepIndex, message) {
                    return new Promise(resolve => {
                        // Realistic delays based on step complexity
                        const delays = [500, 800, 1200, 1500, 1000, 800, 1200, 600];
                        const delay = delays[stepIndex] || 800;
                        
                        setTimeout(() => {
                            console.log(`[Step ${stepIndex + 1}] ${message}`);
                            
                            // Add realistic issues during certain steps
                            if (this.analysisType === 'review') {
                                if (stepIndex === 2) {
                                    this.addRealTimeIssue('Variable naming', 'medium', 'snake_case recommended for Python variables');
                                } else if (stepIndex === 3) {
                                    this.addRealTimeIssue('Security check', 'low', 'No critical vulnerabilities detected');
                                } else if (stepIndex === 4) {
                                    this.addRealTimeIssue('Performance', 'medium', 'Loop optimization opportunity found');
                                } else if (stepIndex === 5) {
                                    this.addRealTimeIssue('Code quality', 'low', 'Function complexity is acceptable');
                                }
                            }
                            
                            resolve();
                        }, delay);
                    });
                },
                
                getMockReviewResults() {
                    const fileName = this.selectedFile.name;
                    const fileExt = fileName.split('.').pop()?.toLowerCase();
                    
                    return [
                        {
                            id: 1,
                            title: 'Code Quality Issue',
                            description: `Potential improvement found in ${fileName}`,
                            severity: fileExt === 'py' ? 'medium' : 'low',
                            category: 'maintainability',
                            codeSnippet: '// Code snippet would appear here',
                            recommendation: 'Consider refactoring for better readability',
                            suggestedFix: '// Improved code would appear here'
                        },
                        {
                            id: 2,
                            title: 'Best Practice Suggestion',
                            description: 'Code follows most best practices with minor suggestions',
                            severity: 'low',
                            category: 'style',
                            recommendation: 'Overall code quality is good'
                        }
                    ];
                },
                
                getMockTestResults() {
                    const fileName = this.selectedFile.name;
                    const fileExt = fileName.split('.').pop()?.toLowerCase();
                    
                    const testTemplate = fileExt === 'py' ? 
                        `import unittest\nfrom ${fileName.replace('.py', '')} import *\n\nclass Test${fileName.replace('.py', '').replace(/[^a-zA-Z0-9]/g, '')}(unittest.TestCase):\n    def test_basic_functionality(self):\n        # Test basic functionality\n        self.assertTrue(True)\n        \n    def test_edge_cases(self):\n        # Test edge cases\n        self.assertIsNotNone(None)\n\nif __name__ == '__main__':\n    unittest.main()` :
                        `// Test file for ${fileName}\ndescribe('${fileName}', () => {\n    test('should work correctly', () => {\n        expect(true).toBe(true);\n    });\n});`;
                    
                    return {
                        test_code: testTemplate,
                        explanation: `Generated comprehensive test cases for ${fileName}`,
                        coverage_areas: [
                            'Basic functionality testing',
                            'Edge case handling',
                            'Input validation',
                            'Error handling'
                        ]
                    };
                },
                
                getAnalysisMessage() {
                    if (this.analysisType === 'review') {
                        return 'Analyzing code quality, security, and best practices...';
                    } else if (this.analysisType === 'test') {
                        return 'Generating comprehensive test cases for your code...';
                    }
                    return 'Processing your request...';
                },
                
                getAnalysisStepMessage() {
                    if (this.analysisType === 'review') {
                        return 'Checking for issues and improvements...';
                    } else if (this.analysisType === 'test') {
                        return 'Creating test scenarios...';
                    }
                    return 'Processing analysis...';
                },
                
                processReviewResults(analysis) {
                    const results = [];
                    
                    console.log('Processing review results:', analysis);
                    
                    // Process issues from AI response
                    if (analysis.issues && Array.isArray(analysis.issues)) {
                        analysis.issues.forEach((issue, index) => {
                            results.push({
                                id: index + 1,
                                title: issue.issue_description || 'Code Issue',
                                description: issue.issue_description || issue.explanation || 'No description',
                                severity: issue.severity || 'medium',
                                category: issue.category || 'maintainability',
                                codeSnippet: issue.old_content || '',
                                recommendation: issue.explanation || '',
                                suggestedFix: issue.new_content || '',
                                oldContent: issue.old_content || '',
                                lineNumber: issue.line_number || 1
                            });
                        });
                        
                        console.log('Processed issues:', results);
                        return results;
                    }
                    
                    // Fallback: Process legacy format if exists
                    if (analysis.suggested_changes && Array.isArray(analysis.suggested_changes)) {
                        analysis.suggested_changes.forEach(change => {
                            const relatedIssueIndex = change.issue_index || 0;
                            
                            if (results[relatedIssueIndex]) {
                                results[relatedIssueIndex].suggestedFix = change.new_content;
                                results[relatedIssueIndex].oldContent = change.old_content;
                                results[relatedIssueIndex].lineNumber = change.line_number;
                            } else {
                                // Create a new result for standalone suggestions
                                results.push({
                                    id: results.length + 1,
                                    title: change.explanation || 'Code Improvement',
                                    description: change.explanation || 'Suggested improvement',
                                    severity: 'medium',
                                    category: 'improvement',
                                    codeSnippet: change.old_content || '',
                                    recommendation: change.explanation || '',
                                    suggestedFix: change.new_content,
                                    oldContent: change.old_content,
                                    lineNumber: change.line_number
                                });
                            }
                        });
                    }
                    
                    console.log('Final processed results:', results);
                    return results;
                },
                
                processTestResults(tests) {
                    // Update the tests tab with generated test code
                    this.generatedTests = tests;
                    
                    // Show a notification
                    if (tests.test_code) {
                        console.log('Generated test code:', tests.test_code);
                    }
                },
                
                processSuggestions(improvements) {
                    // Process improvements similar to review results
                    this.suggestions = this.processReviewResults(improvements);
                },
                
                extractIssueTitle(description) {
                    // Extract a short title from the issue description
                    const sentences = description.split('.')[0];
                    return sentences.length > 60 ? sentences.substring(0, 60) + '...' : sentences;
                },
                
                determineSeverity(description) {
                    const lowerDesc = description.toLowerCase();
                    if (lowerDesc.includes('critical') || lowerDesc.includes('security') || lowerDesc.includes('vulnerability')) {
                        return 'critical';
                    } else if (lowerDesc.includes('error') || lowerDesc.includes('bug') || lowerDesc.includes('problem')) {
                        return 'high';
                    } else if (lowerDesc.includes('warning') || lowerDesc.includes('improvement')) {
                        return 'medium';
                    } else {
                        return 'low';
                    }
                },
                
                categorizeIssue(description) {
                    const lowerDesc = description.toLowerCase();
                    if (lowerDesc.includes('security') || lowerDesc.includes('vulnerability')) {
                        return 'security';
                    } else if (lowerDesc.includes('performance') || lowerDesc.includes('slow') || lowerDesc.includes('memory')) {
                        return 'performance';
                    } else if (lowerDesc.includes('test') || lowerDesc.includes('coverage')) {
                        return 'testing';
                    } else if (lowerDesc.includes('style') || lowerDesc.includes('format')) {
                        return 'style';
                    } else {
                        return 'maintainability';
                    }
                },
                
                extractRecommendation(description) {
                    // Extract recommendation part from description
                    const parts = description.split(/[.!?]/);
                    return parts.length > 1 ? parts.slice(1).join('.').trim() : description;
                },
                
                copyTestCode() {
                    if (this.generatedTests && this.generatedTests.test_code) {
                        navigator.clipboard.writeText(this.generatedTests.test_code).then(() => {
                            // Show a temporary success message
                            const button = event.target.closest('button');
                            const originalText = button.innerHTML;
                            button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                            button.classList.remove('btn-primary');
                            button.classList.add('btn-success');
                            
                            setTimeout(() => {
                                button.innerHTML = originalText;
                                button.classList.remove('btn-success');
                                button.classList.add('btn-primary');
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy text: ', err);
                            alert('Failed to copy test code to clipboard');
                        });
                    }
                },
                
                applyFix(result) {
                    if (!this.monacoEditor || !result.suggestedFix) {
                        console.warn('Cannot apply fix: missing editor or suggested fix');
                        this.showNotification('error', 'Cannot apply fix: missing editor or suggested fix');
                        return;
                    }
                    
                    try {
                        console.log('Applying fix:', result);
                        
                        const rawEditor = Alpine.raw(this.monacoEditor);
                        const model = rawEditor.getModel();
                        
                        if (!model) {
                            console.error('No model available in editor');
                            this.showNotification('error', 'Editor model not available');
                            return;
                        }
                        
                        // Handle empty new content (removal)
                        if (!result.suggestedFix || result.suggestedFix.trim() === '') {
                            this.showNotification('warning', 'This suggestion removes code. Please manually delete the highlighted code.');
                            this.highlightCodeInEditor(result.lineNumber, result.oldContent);
                            return;
                        }
                        
                        // Get line number from result with better parsing
                        const lineInfo = this.parseLineNumber(result.lineNumber);
                        if (!lineInfo.valid) {
                            this.showNotification('error', `Invalid line number format: ${result.lineNumber}`);
                            return;
                        }
                        
                        // Find the exact location of the old content
                        const location = this.findCodeLocation(model, result.oldContent, lineInfo.start);
                        if (!location.found) {
                            this.showNotification('warning', 'Could not find exact code location. Applying at suggested line.');
                            location.startLine = lineInfo.start;
                            location.endLine = lineInfo.end || lineInfo.start;
                        }
                        
                        // Create precise range for replacement
                        const range = new monaco.Range(
                            location.startLine, 1,
                            location.endLine, model.getLineMaxColumn(location.endLine)
                        );
                        
                        // Apply the edit with undo/redo support
                        const edit = {
                            range: range,
                            text: result.suggestedFix,
                            forceMoveMarkers: true
                        };
                        
                        rawEditor.executeEdits('ai-fix', [edit]);
                        
                        // Move cursor to the applied change and highlight it
                        const newRange = new monaco.Range(
                            location.startLine, 1,
                            location.startLine + result.suggestedFix.split('\n').length - 1,
                            model.getLineMaxColumn(location.startLine + result.suggestedFix.split('\n').length - 1)
                        );
                        
                        rawEditor.setSelection(newRange);
                        rawEditor.revealRangeInCenter(newRange);
                        
                        // Add temporary decoration to highlight the change
                        const decorations = rawEditor.deltaDecorations([], [{
                            range: newRange,
                            options: {
                                className: 'ai-applied-fix-highlight',
                                glyphMarginClassName: 'ai-applied-fix-glyph'
                            }
                        }]);
                        
                        // Remove highlight after 3 seconds
                        setTimeout(() => {
                            rawEditor.deltaDecorations(decorations, []);
                        }, 3000);
                        
                        console.log('Fix applied successfully');
                        this.showNotification('success', 'Fix applied successfully!');
                        
                        // Update button state temporarily
                        const button = event?.target?.closest('button');
                        if (button) {
                            this.updateButtonState(button, 'success', 'Applied!', 'fas fa-check');
                        }
                        
                    } catch (error) {
                        console.error('Error applying fix:', error);
                        this.showNotification('error', `Error applying fix: ${error.message}`);
                    }
                },
                
                parseLineNumber(lineNumber) {
                    try {
                        if (typeof lineNumber === 'number') {
                            return { valid: true, start: lineNumber, end: lineNumber };
                        }
                        
                        if (typeof lineNumber === 'string') {
                            if (lineNumber.includes('-')) {
                                const [start, end] = lineNumber.split('-').map(s => parseInt(s.trim()));
                                if (isNaN(start) || isNaN(end)) {
                                    return { valid: false };
                                }
                                return { valid: true, start: start, end: end };
                            } else {
                                const line = parseInt(lineNumber.trim());
                                if (isNaN(line)) {
                                    return { valid: false };
                                }
                                return { valid: true, start: line, end: line };
                            }
                        }
                        
                        return { valid: false };
                    } catch (error) {
                        return { valid: false };
                    }
                },
                
                findCodeLocation(model, oldContent, suggestedLine) {
                    const totalLines = model.getLineCount();
                    const oldLines = oldContent.split('\n');
                    const firstOldLine = oldLines[0].trim();
                    
                    // Start search from suggested line, then expand
                    const searchStart = Math.max(1, suggestedLine - 2);
                    const searchEnd = Math.min(totalLines, suggestedLine + 10);
                    
                    // First, try to find exact match near suggested line
                    for (let i = searchStart; i <= searchEnd; i++) {
                        const currentLine = model.getLineContent(i).trim();
                        if (currentLine === firstOldLine) {
                            // Check if the following lines also match
                            let allMatch = true;
                            for (let j = 1; j < oldLines.length && (i + j) <= totalLines; j++) {
                                const nextLine = model.getLineContent(i + j).trim();
                                const expectedLine = oldLines[j].trim();
                                if (nextLine !== expectedLine) {
                                    allMatch = false;
                                    break;
                                }
                            }
                            if (allMatch) {
                                return {
                                    found: true,
                                    startLine: i,
                                    endLine: i + oldLines.length - 1
                                };
                            }
                        }
                    }
                    
                    // If exact match not found, try fuzzy matching
                    for (let i = searchStart; i <= searchEnd; i++) {
                        const currentLine = model.getLineContent(i).trim();
                        if (currentLine.includes(firstOldLine.substring(0, Math.min(20, firstOldLine.length)))) {
                            return {
                                found: false,
                                startLine: i,
                                endLine: i + oldLines.length - 1
                            };
                        }
                    }
                    
                    // Fallback to suggested line
                    return {
                        found: false,
                        startLine: suggestedLine,
                        endLine: suggestedLine + oldLines.length - 1
                    };
                },
                
                highlightCodeInEditor(lineNumber, content) {
                    try {
                        const rawEditor = Alpine.raw(this.monacoEditor);
                        const lineInfo = this.parseLineNumber(lineNumber);
                        
                        if (lineInfo.valid) {
                            const range = new monaco.Range(lineInfo.start, 1, lineInfo.end, rawEditor.getModel().getLineMaxColumn(lineInfo.end));
                            rawEditor.setSelection(range);
                            rawEditor.revealRangeInCenter(range);
                        }
                    } catch (error) {
                        console.warn('Could not highlight code:', error);
                    }
                },
                
                updateButtonState(button, type, text, icon) {
                    const originalHtml = button.innerHTML;
                    const colors = {
                        success: 'btn-success',
                        error: 'btn-danger',
                        warning: 'btn-warning'
                    };
                    
                    button.innerHTML = `<i class="${icon} mr-1"></i>${text}`;
                    button.classList.remove('btn-primary', 'btn-secondary');
                    button.classList.add(colors[type] || 'btn-primary');
                    button.disabled = true;
                    
                    setTimeout(() => {
                        button.innerHTML = originalHtml;
                        button.classList.remove(...Object.values(colors));
                        button.classList.add('btn-primary');
                        button.disabled = false;
                    }, 2000);
                },
                
                showNotification(type, message) {
                    // Create notification element
                    const notification = document.createElement('div');
                    notification.className = `fixed top-4 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
                    
                    const colors = {
                        success: 'bg-green-600 text-white',
                        error: 'bg-red-600 text-white',
                        warning: 'bg-yellow-600 text-black',
                        info: 'bg-blue-600 text-white'
                    };
                    
                    const icons = {
                        success: 'fas fa-check-circle',
                        error: 'fas fa-exclamation-circle',
                        warning: 'fas fa-exclamation-triangle',
                        info: 'fas fa-info-circle'
                    };
                    
                    notification.classList.add(...colors[type].split(' '));
                    notification.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <i class="${icons[type]}"></i>
                            <span>${message}</span>
                            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Animate in
                    setTimeout(() => {
                        notification.classList.remove('translate-x-full');
                    }, 100);
                    
                    // Auto remove after 5 seconds
                    setTimeout(() => {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 300);
                    }, 5000);
                },
                
                async commitChanges() {
                    if (!this.selectedFile || !this.monacoEditor || !this.hasChanges) return;
                    
                    const newContent = this.monacoEditor.getValue();
                    const commitMessage = prompt('Enter commit message:', `Update ${this.selectedFile.name}`);
                    
                    if (!commitMessage) return;
                    
                    try {
                        this.loading = true;
                        this.loadingMessage = 'Committing changes...';
                        
                        const response = await fetch(`/gitlab/repository/${this.projectId}/commit`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                file_path: this.selectedFile.path,
                                branch: this.currentBranch,
                                content: newContent,
                                commit_message: commitMessage
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            this.hasChanges = false;
                            this.selectedFile.content = newContent;
                            alert('Changes committed successfully!');
                            await this.loadCommits(); // Refresh commits
                        } else {
                            alert('Error committing changes: ' + result.error);
                        }
                        
                        this.loading = false;
                        
                    } catch (error) {
                        console.error('Error committing changes:', error);
                        alert('Error committing changes: ' + error.message);
                        this.loading = false;
                    }
                },
                
                // UI Helpers
                async switchBranch() {
                    await this.loadFileTree();
                    await this.loadCommits();
                    if (this.selectedFile) {
                        await this.selectFile(this.selectedFile);
                    }
                },
                
                viewCommit(commit) {
                    window.open(commit.web_url, '_blank');
                },
                
                viewPullRequest(pr) {
                    // Open PR in new tab or show details
                    console.log('View PR:', pr);
                },
                
                navigateToPath(path) {
                    this.loadFileTree(path);
                },
                
                // Computed properties
                get pathParts() {
                    return this.currentPath ? this.currentPath.split('/') : [];
                },
                
                get filteredPullRequests() {
                    return this.pullRequests.filter(pr => 
                        this.prFilter === 'open' ? pr.state === 'opened' : pr.state === 'merged'
                    );
                },
                
                getPathUpTo(index) {
                    return this.pathParts.slice(0, index + 1).join('/');
                },
                
                getFileIcon(item) {
                    if (item.type === 'tree') return 'fas fa-folder text-blue-400';
                    
                    const ext = item.name.split('.').pop()?.toLowerCase();
                    const iconMap = {
                        'py': 'fab fa-python text-yellow-400',
                        'js': 'fab fa-js-square text-yellow-500',
                        'ts': 'fas fa-code text-blue-500',
                        'html': 'fab fa-html5 text-orange-500',
                        'css': 'fab fa-css3-alt text-blue-500',
                        'json': 'fas fa-file-code text-green-400',
                        'md': 'fab fa-markdown text-gray-400',
                        'yml': 'fas fa-file-code text-red-400',
                        'yaml': 'fas fa-file-code text-red-400'
                    };
                    return iconMap[ext] || 'fas fa-file text-gray-400';
                },
                
                getFileLanguage(file) {
                    const ext = file.name.split('.').pop()?.toLowerCase();
                    const langMap = {
                        'py': 'Python',
                        'js': 'JavaScript',
                        'ts': 'TypeScript',
                        'html': 'HTML',
                        'css': 'CSS',
                        'json': 'JSON',
                        'md': 'Markdown'
                    };
                    return langMap[ext] || 'Text';
                },
                
                getMonacoLanguage(filename) {
                    if (!filename || typeof filename !== 'string') {
                        console.warn('[getMonacoLanguage] Invalid filename provided:', filename);
                        return 'plaintext'; // Default if filename is bad
                    }
                    const parts = filename.split('.');
                    const ext = parts.length > 1 ? parts.pop().toLowerCase() : null;
                    
                    if (!ext) {
                        console.warn('[getMonacoLanguage] No extension found for:', filename);
                        return 'plaintext';
                    }

                    const langMap = {
                        'py': 'python',
                        'js': 'javascript',
                        'ts': 'typescript',
                        'html': 'html',
                        'css': 'css',
                        'json': 'json',
                        'md': 'markdown',
                        'yml': 'yaml',
                        'yaml': 'yaml'
                    };
                    return langMap[ext] || 'plaintext';
                },
                
                getPRIcon(state) {
                    return state === 'opened' ? 
                        'w-2 h-2 bg-green-500 rounded-full' : 
                        'w-2 h-2 bg-purple-500 rounded-full';
                },
                
                getSeverityIcon(severity) {
                    const icons = {
                        'critical': 'fas fa-exclamation-triangle text-red-500',
                        'high': 'fas fa-exclamation-circle text-orange-500',
                        'medium': 'fas fa-exclamation text-yellow-500',
                        'low': 'fas fa-info-circle text-green-500'
                    };
                    return icons[severity] || icons.medium;
                },
                
                getSeverityBadge(severity) {
                    const badges = {
                        'critical': 'bg-red-500 text-white',
                        'high': 'bg-orange-500 text-white',
                        'medium': 'bg-yellow-500 text-black',
                        'low': 'bg-green-500 text-white'
                    };
                    return badges[severity] || badges.medium;
                },
                
                getSeverityColor(severity) {
                    const colors = {
                        'critical': 'bg-red-500',
                        'high': 'bg-orange-500',
                        'medium': 'bg-yellow-500',
                        'low': 'bg-green-500'
                    };
                    return colors[severity] || colors.medium;
                },
                
                formatFileSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diff = now - date;
                    
                    if (diff < 24 * 60 * 60 * 1000) {
                        return 'Today';
                    } else if (diff < 7 * 24 * 60 * 60 * 1000) {
                        return Math.floor(diff / (24 * 60 * 60 * 1000)) + ' days ago';
                    } else {
                        return date.toLocaleDateString();
                    }
                },
                
                // Progress tracking methods
                initializeProgress(type) {
                    this.analysisProgress = 0;
                    this.analysisStartTime = Date.now();
                    this.currentInsights = [];
                    this.analysisStats = { issuesFound: 0, linesAnalyzed: 0, suggestions: 0 };
                    this.realTimeIssues = [];
                    
                    // Define steps based on analysis type
                    if (type === 'review') {
                        this.analysisSteps = [
                            { name: 'Reading file content', status: 'pending', result: null },
                            { name: 'Parsing code structure', status: 'pending', result: null },
                            { name: 'Analyzing syntax patterns', status: 'pending', result: null },
                            { name: 'Checking security vulnerabilities', status: 'pending', result: null },
                            { name: 'Identifying performance issues', status: 'pending', result: null },
                            { name: 'Evaluating code quality', status: 'pending', result: null },
                            { name: 'Generating suggestions', status: 'pending', result: null },
                            { name: 'Finalizing analysis', status: 'pending', result: null }
                        ];
                    } else if (type === 'test') {
                        this.analysisSteps = [
                            { name: 'Reading file content', status: 'pending', result: null },
                            { name: 'Understanding code logic', status: 'pending', result: null },
                            { name: 'Identifying test scenarios', status: 'pending', result: null },
                            { name: 'Analyzing edge cases', status: 'pending', result: null },
                            { name: 'Creating test cases', status: 'pending', result: null },
                            { name: 'Generating test code', status: 'pending', result: null },
                            { name: 'Optimizing test coverage', status: 'pending', result: null }
                        ];
                    }
                    
                    this.updateStep(0);
                },
                
                addRealTimeIssue(title, severity, preview) {
                    this.realTimeIssues.push({
                        id: Date.now() + Math.random(),
                        title: title,
                        severity: severity,
                        preview: preview
                    });
                    
                    // Update stats
                    this.analysisStats.issuesFound = this.realTimeIssues.length;
                },
                
                updateStep(stepIndex) {
                    // Mark previous steps as completed
                    for (let i = 0; i < stepIndex && i < this.analysisSteps.length; i++) {
                        if (this.analysisSteps[i].status !== 'completed') {
                            this.analysisSteps[i].status = 'completed';
                        }
                    }
                    
                    // Set current step as active
                    if (stepIndex < this.analysisSteps.length) {
                        this.analysisSteps[stepIndex].status = 'active';
                        this.currentStep = {
                            title: this.analysisSteps[stepIndex].name,
                            description: this.getStepDescription(stepIndex)
                        };
                        
                        // Update progress
                        this.analysisProgress = (stepIndex / this.analysisSteps.length) * 100;
                        
                        // Add realistic insights
                        this.addInsight(stepIndex);
                    }
                },
                
                completeStep(stepIndex, result = null) {
                    if (stepIndex < this.analysisSteps.length) {
                        this.analysisSteps[stepIndex].status = 'completed';
                        this.analysisSteps[stepIndex].result = result;
                        
                        // Update stats based on step
                        this.updateStatsForStep(stepIndex, result);
                        
                        // Move to next step
                        if (stepIndex + 1 < this.analysisSteps.length) {
                            setTimeout(() => this.updateStep(stepIndex + 1), 800);
                        } else {
                            // Analysis complete
                            this.analysisProgress = 100;
                            this.currentStep = {
                                title: 'Analysis Complete',
                                description: 'Processing results and generating recommendations'
                            };
                        }
                    }
                },
                
                getStepDescription(stepIndex) {
                    const descriptions = {
                        'review': [
                            'Extracting code content from the editor',
                            'Building abstract syntax tree and code structure',
                            'Analyzing language-specific patterns and idioms',
                            'Scanning for common security vulnerabilities',
                            'Identifying inefficient algorithms and bottlenecks',
                            'Evaluating maintainability and best practices',
                            'Generating actionable improvement suggestions',
                            'Compiling results and formatting output'
                        ],
                        'test': [
                            'Extracting and preprocessing source code',
                            'Mapping functions, classes, and dependencies',
                            'Identifying testable units and behaviors',
                            'Finding boundary conditions and error cases',
                            'Designing comprehensive test scenarios',
                            'Writing executable test implementations',
                            'Ensuring maximum code path coverage'
                        ]
                    };
                    
                    return descriptions[this.analysisType]?.[stepIndex] || 'Processing...';
                },
                
                addInsight(stepIndex) {
                    const insights = {
                        'review': [
                            'Found Python file with 150+ lines',
                            'Detected function definitions and imports',
                            'Analyzing variable naming conventions',
                            'Checking for SQL injection vulnerabilities',
                            'Evaluating loop efficiency and complexity',
                            'Assessing code documentation quality',
                            'Prioritizing high-impact improvements',
                            'Validating suggested fixes'
                        ],
                        'test': [
                            'Identified 8 functions to test',
                            'Mapped input/output relationships',
                            'Found 12 potential test scenarios',
                            'Discovered 5 edge cases to validate',
                            'Creating unit and integration tests',
                            'Generating pytest-compatible code',
                            'Aiming for 90%+ code coverage'
                        ]
                    };
                    
                    const insight = insights[this.analysisType]?.[stepIndex];
                    if (insight) {
                        this.currentInsights.push({
                            id: Date.now() + Math.random(),
                            text: insight
                        });
                        
                        // Keep only last 3 insights visible
                        if (this.currentInsights.length > 3) {
                            this.currentInsights = this.currentInsights.slice(-3);
                        }
                    }
                },
                
                updateStatsForStep(stepIndex, result) {
                    // Simulate realistic stats updates
                    if (stepIndex === 0) {
                        const content = this.monacoEditor ? Alpine.raw(this.monacoEditor).getValue() : '';
                        this.analysisStats.linesAnalyzed = content.split('\n').length;
                    } else if (stepIndex === 3 && this.analysisType === 'review') {
                        this.analysisStats.issuesFound = Math.floor(Math.random() * 3) + 1;
                    } else if (stepIndex === 6 && this.analysisType === 'review') {
                        this.analysisStats.suggestions = this.analysisStats.issuesFound + Math.floor(Math.random() * 2);
                    }
                },
                
                formatElapsedTime(startTime) {
                    if (!startTime) return '0s';
                    const elapsed = Date.now() - startTime;
                    const seconds = Math.floor(elapsed / 1000);
                    const minutes = Math.floor(seconds / 60);
                    
                    if (minutes > 0) {
                        return `${minutes}m ${seconds % 60}s`;
                    }
                    return `${seconds}s`;
                },
                
                // Panel resizing
                startResize(event) {
                    event.preventDefault();
                    
                    const startY = event.clientY;
                    const startHeight = parseInt(document.defaultView.getComputedStyle(document.querySelector('.bottom-panel')).height, 10);
                    
                    function doResize(e) {
                        const newHeight = startHeight - (e.clientY - startY);
                        const minHeight = 200;
                        const maxHeight = window.innerHeight - 300;
                        
                        if (newHeight >= minHeight && newHeight <= maxHeight) {
                            document.documentElement.style.setProperty('--bottom-panel-height', newHeight + 'px');
                        }
                    }
                    
                    function stopResize() {
                        document.removeEventListener('mousemove', doResize);
                        document.removeEventListener('mouseup', stopResize);
                    }
                    
                    document.addEventListener('mousemove', doResize);
                    document.addEventListener('mouseup', stopResize);
                },
                viewDiff(result) {
                    // Toggle diff display for this result
                    result.showDiff = !result.showDiff;
                }
            }
        }
    </script>
</body>
</html> 